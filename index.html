
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <style media="screen">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <style media="print">
      * {
        -webkit-transition:none!important;
        transition:none!important;
      }
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #586e75;
}
.highlight .err {
  color: #002b36;
  background-color: #dc322f;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #657b83;
}
.highlight .cp {
  color: #b58900;
}
.highlight .nt {
  color: #b58900;
}
.highlight .o, .highlight .ow {
  color: #93a1a1;
}
.highlight .p, .highlight .pi {
  color: #93a1a1;
}
.highlight .gi {
  color: #859900;
}
.highlight .gd {
  color: #dc322f;
}
.highlight .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #6c71c4;
}
.highlight .kc {
  color: #cb4b16;
}
.highlight .kt {
  color: #cb4b16;
}
.highlight .kd {
  color: #cb4b16;
}
.highlight .s, .highlight .sa, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #859900;
}
.highlight .sr {
  color: #2aa198;
}
.highlight .si {
  color: #d33682;
}
.highlight .se {
  color: #d33682;
}
.highlight .nn {
  color: #b58900;
}
.highlight .nc {
  color: #b58900;
}
.highlight .no {
  color: #b58900;
}
.highlight .na {
  color: #268bd2;
}
.highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #859900;
}
.highlight .ss {
  color: #859900;
}
    </style>
    <link href="stylesheets/screen-920d2558.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-953e3353.css" rel="stylesheet" media="print" />
      <script src="javascripts/all-e9bde216.js"></script>

    <script>
      $(function() { setupCodeCopy(); });
    </script>

    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>

  <body class="index" data-languages="[&quot;shell&quot;,&quot;typescript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo-tp-b6d0fa3a.png" class="logo" alt="" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">Shell</a>
              <a href="#" data-language-name="typescript">TypeScript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
          </li>
          <li>
            <a href="#architecture" class="toc-h1 toc-link" data-title="Architecture">Architecture</a>
          </li>
          <li>
            <a href="#injective-chain" class="toc-h1 toc-link" data-title="Injective Chain">Injective Chain</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#layer-2-evm-execution-environment" class="toc-h2 toc-link" data-title="Layer-2 EVM Execution Environment">Layer-2 EVM Execution Environment</a>
                  </li>
                  <li>
                    <a href="#decentralized-orderbook" class="toc-h2 toc-link" data-title="Decentralized Orderbook">Decentralized Orderbook</a>
                  </li>
                  <li>
                    <a href="#trade-execution-coordinator" class="toc-h2 toc-link" data-title="Trade Execution Coordinator">Trade Execution Coordinator</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#injective-exchange-client" class="toc-h1 toc-link" data-title="Injective Exchange Client">Injective Exchange Client</a>
          </li>
          <li>
            <a href="#injective-api-provider" class="toc-h1 toc-link" data-title="Injective API Provider">Injective API Provider</a>
          </li>
          <li>
            <a href="#injective-evm-rpc-provider" class="toc-h1 toc-link" data-title="Injective EVM RPC provider">Injective EVM RPC provider</a>
          </li>
          <li>
            <a href="#injective-ethereum-bridge" class="toc-h1 toc-link" data-title="Injective ⮂ Ethereum Bridge">Injective ⮂ Ethereum Bridge</a>
          </li>
          <li>
            <a href="#token-economics" class="toc-h1 toc-link" data-title="Token Economics">Token Economics</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#1-proof-of-stake-security" class="toc-h2 toc-link" data-title="1. Proof of Stake Security">1. Proof of Stake Security</a>
                  </li>
                  <li>
                    <a href="#2-governance" class="toc-h2 toc-link" data-title="2.  Governance">2.  Governance</a>
                  </li>
                  <li>
                    <a href="#3-market-maker-incentives" class="toc-h2 toc-link" data-title="3. Market Maker Incentives">3. Market Maker Incentives</a>
                  </li>
                  <li>
                    <a href="#4-relayer-incentives" class="toc-h2 toc-link" data-title="4. Relayer Incentives">4. Relayer Incentives</a>
                  </li>
                  <li>
                    <a href="#5-exchange-fee-value-accrual" class="toc-h2 toc-link" data-title="5. Exchange Fee Value Accrual">5. Exchange Fee Value Accrual</a>
                  </li>
                  <li>
                    <a href="#6-collateral-backing-for-derivatives" class="toc-h2 toc-link" data-title="6. Collateral Backing for Derivatives">6. Collateral Backing for Derivatives</a>
                  </li>
                  <li>
                    <a href="#7-exchange-participation-incentives" class="toc-h2 toc-link" data-title="7. Exchange participation incentives">7. Exchange participation incentives</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#derivatives-specification" class="toc-h1 toc-link" data-title="Derivatives Specification">Derivatives Specification</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#overview" class="toc-h2 toc-link" data-title="Overview">Overview</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#key-terms" class="toc-h1 toc-link" data-title="Key Terms">Key Terms</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#perpetual-swap" class="toc-h2 toc-link" data-title="Perpetual Swap"><strong>Perpetual Swap</strong></a>
                  </li>
                  <li>
                    <a href="#cfd" class="toc-h2 toc-link" data-title="CFD"><strong>CFD</strong></a>
                  </li>
                  <li>
                    <a href="#address" class="toc-h2 toc-link" data-title="Address"><strong>Address</strong></a>
                  </li>
                  <li>
                    <a href="#subaccount" class="toc-h2 toc-link" data-title="Subaccount"><strong>Subaccount</strong></a>
                  </li>
                  <li>
                    <a href="#deposits" class="toc-h2 toc-link" data-title="Deposits"><strong>Deposits</strong></a>
                  </li>
                  <li>
                    <a href="#market" class="toc-h2 toc-link" data-title="Market"><strong>Market</strong></a>
                  </li>
                  <li>
                    <a href="#direction" class="toc-h2 toc-link" data-title="Direction"><strong>Direction</strong></a>
                  </li>
                  <li>
                    <a href="#index-price" class="toc-h2 toc-link" data-title="Index Price"><strong>Index Price</strong></a>
                  </li>
                  <li>
                    <a href="#contract-price" class="toc-h2 toc-link" data-title="Contract Price"><strong>Contract Price</strong></a>
                  </li>
                  <li>
                    <a href="#execution-price" class="toc-h2 toc-link" data-title="Execution Price"><strong>Execution Price</strong></a>
                  </li>
                  <li>
                    <a href="#quantity" class="toc-h2 toc-link" data-title="Quantity"><strong>Quantity</strong></a>
                  </li>
                  <li>
                    <a href="#position" class="toc-h2 toc-link" data-title="Position"><strong>Position</strong></a>
                  </li>
                  <li>
                    <a href="#margin" class="toc-h2 toc-link" data-title="Margin"><strong>Margin</strong></a>
                  </li>
                  <li>
                    <a href="#contract" class="toc-h2 toc-link" data-title="Contract"><strong>Contract</strong></a>
                  </li>
                  <li>
                    <a href="#order" class="toc-h2 toc-link" data-title="Order"><strong>Order</strong></a>
                  </li>
                  <li>
                    <a href="#funding" class="toc-h2 toc-link" data-title="Funding"><strong>Funding</strong></a>
                  </li>
                  <li>
                    <a href="#funding-rate" class="toc-h2 toc-link" data-title="Funding Rate"><strong>Funding Rate</strong></a>
                  </li>
                  <li>
                    <a href="#funding-fee" class="toc-h2 toc-link" data-title="Funding Fee"><strong>Funding Fee</strong></a>
                  </li>
                  <li>
                    <a href="#npv" class="toc-h2 toc-link" data-title="NPV"><strong>NPV</strong></a>
                  </li>
                  <li>
                    <a href="#nav" class="toc-h2 toc-link" data-title="NAV"><strong>NAV</strong></a>
                  </li>
                  <li>
                    <a href="#liquidation" class="toc-h2 toc-link" data-title="Liquidation"><strong>Liquidation</strong></a>
                  </li>
                  <li>
                    <a href="#vaporization" class="toc-h2 toc-link" data-title="Vaporization"><strong>Vaporization</strong></a>
                  </li>
                  <li>
                    <a href="#maintenance-margin-requirement" class="toc-h2 toc-link" data-title="Maintenance Margin Requirement"><strong>Maintenance Margin Requirement</strong></a>
                  </li>
                  <li>
                    <a href="#initial-margin-requirement" class="toc-h2 toc-link" data-title="Initial Margin Requirement"><strong>Initial Margin Requirement</strong></a>
                  </li>
                  <li>
                    <a href="#liquidation-price" class="toc-h2 toc-link" data-title="Liquidation Price">Liquidation Price</a>
                  </li>
                  <li>
                    <a href="#clawback" class="toc-h2 toc-link" data-title="Clawback"><strong>Clawback</strong></a>
                  </li>
                  <li>
                    <a href="#leverage" class="toc-h2 toc-link" data-title="Leverage"><strong>Leverage</strong></a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#make-orders" class="toc-h1 toc-link" data-title="Make Orders">Make Orders</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#order-message-format" class="toc-h2 toc-link" data-title="Order Message Format"><strong>Order Message Format</strong></a>
                  </li>
                  <li>
                    <a href="#isolated-and-cross-margin" class="toc-h2 toc-link" data-title="Isolated and Cross Margin">Isolated and Cross Margin</a>
                  </li>
                  <li>
                    <a href="#stop-limit-order" class="toc-h2 toc-link" data-title="Stop Limit Order">Stop Limit Order</a>
                  </li>
                  <li>
                    <a href="#stop-loss-limit-order" class="toc-h2 toc-link" data-title="Stop Loss Limit Order">Stop Loss Limit Order</a>
                  </li>
                  <li>
                    <a href="#take-profit-limit-order" class="toc-h2 toc-link" data-title="Take Profit Limit Order">Take Profit Limit Order</a>
                  </li>
                  <li>
                    <a href="#close-limit-order" class="toc-h2 toc-link" data-title="Close Limit Order">Close Limit Order</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#transaction-fees" class="toc-h1 toc-link" data-title="Transaction Fees">Transaction Fees</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#maker-fees" class="toc-h2 toc-link" data-title="Maker Fees">Maker Fees</a>
                  </li>
                  <li>
                    <a href="#taker-fees" class="toc-h2 toc-link" data-title="Taker Fees">Taker Fees</a>
                  </li>
                  <li>
                    <a href="#order-validation" class="toc-h2 toc-link" data-title="Order Validation">Order Validation</a>
                  </li>
                  <li>
                    <a href="#cancelorder" class="toc-h2 toc-link" data-title="cancelOrder">cancelOrder</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#take-orders" class="toc-h1 toc-link" data-title="Take Orders">Take Orders</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#fillorder" class="toc-h2 toc-link" data-title="fillOrder">fillOrder</a>
                  </li>
                  <li>
                    <a href="#fillorkillorder" class="toc-h2 toc-link" data-title="fillOrKillOrder">fillOrKillOrder</a>
                  </li>
                  <li>
                    <a href="#batchfillorders" class="toc-h2 toc-link" data-title="batchFillOrders">batchFillOrders</a>
                  </li>
                  <li>
                    <a href="#batchfillorkillorders" class="toc-h2 toc-link" data-title="batchFillOrKillOrders">batchFillOrKillOrders</a>
                  </li>
                  <li>
                    <a href="#batchfillorderssingleposition" class="toc-h2 toc-link" data-title="batchFillOrdersSinglePosition">batchFillOrdersSinglePosition</a>
                  </li>
                  <li>
                    <a href="#batchfillorkillorderssingleposition" class="toc-h2 toc-link" data-title="batchFillOrKillOrdersSinglePosition">batchFillOrKillOrdersSinglePosition</a>
                  </li>
                  <li>
                    <a href="#marketorders" class="toc-h2 toc-link" data-title="marketOrders"><strong>marketOrders</strong></a>
                  </li>
                  <li>
                    <a href="#marketordersorkill" class="toc-h2 toc-link" data-title="marketOrdersOrKill"><strong>marketOrdersOrKill</strong></a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#matching-orders" class="toc-h1 toc-link" data-title="Matching Orders">Matching Orders</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#matchorders" class="toc-h2 toc-link" data-title="matchOrders">matchOrders</a>
                  </li>
                  <li>
                    <a href="#multimatchorders" class="toc-h2 toc-link" data-title="multiMatchOrders">multiMatchOrders</a>
                  </li>
                  <li>
                    <a href="#batchmatchorders" class="toc-h2 toc-link" data-title="batchMatchOrders">batchMatchOrders</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#positions" class="toc-h1 toc-link" data-title="Positions">Positions</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#closeposition" class="toc-h2 toc-link" data-title="closePosition">closePosition</a>
                  </li>
                  <li>
                    <a href="#closepositionorkill" class="toc-h2 toc-link" data-title="closePositionOrKill">closePositionOrKill</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#liquidation-2" class="toc-h1 toc-link" data-title="Liquidation">Liquidation</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#liquidatepositionwithorders" class="toc-h2 toc-link" data-title="liquidatePositionWithOrders">liquidatePositionWithOrders</a>
                  </li>
                  <li>
                    <a href="#vaporization-2" class="toc-h2 toc-link" data-title="Vaporization">Vaporization</a>
                  </li>
                  <li>
                    <a href="#vaporizeposition" class="toc-h2 toc-link" data-title="vaporizePosition">vaporizePosition</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#oracle" class="toc-h1 toc-link" data-title="Oracle">Oracle</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#general-concept" class="toc-h2 toc-link" data-title="General concept">General concept</a>
                  </li>
                  <li>
                    <a href="#funding-fee-2" class="toc-h2 toc-link" data-title="Funding Fee">Funding Fee</a>
                  </li>
                  <li>
                    <a href="#testnet-setup" class="toc-h2 toc-link" data-title="Testnet setup">Testnet setup</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#events" class="toc-h1 toc-link" data-title="Events">Events</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#injectivefutures-contract-events" class="toc-h2 toc-link" data-title="InjectiveFutures Contract Events">InjectiveFutures Contract Events</a>
                  </li>
                  <li>
                    <a href="#oracle-contract-events" class="toc-h2 toc-link" data-title="Oracle Contract Events">Oracle Contract Events</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#types" class="toc-h1 toc-link" data-title="Types">Types</a>
          </li>
      </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Welcome to Injective Protocol&#39;s documentation!</p>

<p>Here you can find a comprehensive overview of our protocol, as well as tutorials, guides and general resources for developers.</p>

<p>If you would like to ask any questions or be a part of our community, please join our <a href="https://t.me/joininjective">Telegram Group</a>.</p>
<h1 id='architecture'>Architecture</h1>
<p>Injective Protocol is comprised of five principal components:</p>

<ol>
<li>Injective Chain</li>
<li>Injective Exchange Client</li>
<li>Injective API Provider</li>
<li>Injective EVM RPC provider</li>
<li>Injective Bridge Contracts on Ethereum</li>
</ol>

<p><img src="images/ContractArchitecture-03726ae4.png" alt="" /></p>
<h1 id='injective-chain'>Injective Chain</h1>
<p>The Injective Chain is the core backbone for Injective&#39;s layer-2 derivatives platform and hosts a fully decentralized orderbook, trade execution coordinator, EVM execution environment, and bi-directional token bridge to Ethereum. </p>
<h2 id='layer-2-evm-execution-environment'>Layer-2 EVM Execution Environment</h2>
<p>The Injective Chain supports generalized smart contract execution through a modular implementation of the Ethereum Virtual Machine (EVM) on top of the Cosmos-SDK (based on <a href="https://github.com/chainsafe/ethermint">Ethermint</a>). By implementing the EVM on top of Tendermint, users enjoy a scalable and interoperable implementation of Ethereum built on Proof-of-Stake with 1-block finality.</p>

<p>Developers can enjoy an identical experience for creating dApps on the Injective EVM, with additional benefits including native support for transaction fee delegation and an increased contract bytecode size limit of 100KB. </p>

<p>Upon genesis, the following contracts are deployed on the Injective EVM:</p>
<h3 id='injective-dex-contracts'>Injective DEX Contracts</h3>
<p>The Injective DEX Protocol is a decentralized exchange protocol supporting peer-to-peer spot and derivatives trading. The DEX protocol is implemented through smart contracts (written in Solidity) and is deployed on the Injective Layer-2 EVM execution environment. The 0x V3 Exchange Protocol is used for spot markets and the bespoke Injective Derivatives Protocol is used for derivatives markets. </p>

<p><strong>Injective Derivatives Contracts</strong></p>

<p>The Injective Derivatives Protocol enables traders to create, enter into, and execute decentralized perpetual swap contracts and CFDs on any arbitrary market. Comprehensive details can be found <a href="https://github.com/InjectiveLabs/injective-futures">here</a>.</p>

<p><strong>0x V3 Exchange Contracts</strong></p>

<p>We leverage the 0x V3 Exchange Contracts for peer-to-peer spot exchange. </p>

<p><strong>Injective Coordinator Contract</strong>  </p>

<p>The Injective Coordinator Contract follows the <a href="https://github.com/0xProject/0x-protocol-specification/blob/master/v2/coordinator-specification.md">0x Coordinator</a> specification for both spot 0x transactions. The principal purpose of the coordinator is to serve as a liquidity solution enabling more competitive pricing by preventing front-running and allowing for much lower latency trading. However, unlike traditional implementations which only require one signature from a centralized coordinator, Injective&#39;s decentralized coordinator enforces transactions to have a minimum threshold of coordinator signatures in order for a transaction to be approved. These required signatures are provided through the application logic built into the consensus of the Injective Chain. Each coordinator is bonded through INJ stake and can be slashed for improperly approving transactions.</p>

<p><strong>Staking Contract</strong><br>
The Injective Staking Contract maintains a compressed representation of the Injective Chain&#39;s validator set and is used to govern the Injective Derivatives Protocol and to process cross-chain ERC-20 token deposits/withdrawals. </p>

<p><strong>Injective EVM Bridge Contracts</strong><br>
The Injective Bridge Contracts encompass a suite of smart contracts managing the two-way peg between Ethereum and the Injective Chain. More details can be found <a href="https://github.com/InjectiveLabs/injective-core">here</a>.</p>
<h2 id='decentralized-orderbook'>Decentralized Orderbook</h2>
<p>Injective&#39;s Decentralized Orderbook is a fully decentralized 0x-based orderbook enabling <strong>sidechain order relay with on-chain settlement</strong> - a decentralized implementation of the traditionally centralized <a href="https://github.com/0xProject/0x-protocol-specification/blob/master/v2/v2-specification.md#architecture">off-chain order relay</a> used by nearly all central limit order book decentralized exchanges. </p>

<p>Nodes of the Injective Chain host a decentralized, censorship-resistant orderbook which stores and relays orders for both spot and derivatives trading. </p>
<h2 id='trade-execution-coordinator'>Trade Execution Coordinator</h2>
<p>The Injective Trade Execution Coordinator (TEC) is a decentralized coordinator implementation based off the <a href="https://github.com/0xProject/0x-protocol-specification/blob/master/v3/coordinator-specification.md">0x Coordinator</a> specification. The Injective TEC safeguards trades from front-running using Verifiable Delay Functions and enables lower-latency trading through soft-cancellations.</p>
<h1 id='injective-exchange-client'>Injective Exchange Client</h1>
<p>Injective provides a powerful, full-fledged decentralized exchange open-source front-end implementation allowing anyone to easily participate in our decentralized exchange protocol in a fully permissionless manner. </p>

<p>The Injective Client is a comprehensive yet friendly graphical user interface catered towards the general public as well as more advanced users. Relayers can host the client on a server to allow users to interact with the protocol. Individuals can also run the client from their locally to directly interact with the protocol. The exchange client interface will also be deployed on IPFS.</p>

<ul>
<li><a href="https://github.com/InjectiveLabs/injective-client"><strong>Injective client implementation</strong></a></li>
</ul>
<h1 id='injective-api-provider'>Injective API Provider</h1>
<p>Injective’s model rewards relayers in the Injective network for sourcing liquidity. By doing so, exchange providers are incentivized to better serve users, competing amongst each other to provide better user experience, thus broadening access to DeFi for users all around the world.</p>

<p>Injective API nodes have two purposes: 1) providing transaction relay services and 2) serving as a data layer for the protocol.</p>

<p><strong>Transaction Relay Service</strong><br>
Although users can directly interact with the Injective Chain by broadcasting a compatible Tendermint transaction encoding a compatible message type, doing so would be cumbersome for most users. To this end, API nodes provide users a simple HTTP, gRPC and Websocket API to interact with the protocol. The API nodes then formulate the appropriate transactions and relay them to the Injective Chain. </p>

<p><strong>Data Layer</strong><br>
Injective Exchange API nodes also serve as a data layer for external clients. Injective provides a data and analytics API which is out-of-the-box compatible with Injective&#39;s sample frontend interface. </p>

<p>The Injective API supports the Injective Derivatives and Spot Exchange APIs for the Injective Client, the 0x Standard Coordinator API, the Injective Derivatives Protocol Graph Node GraphQL API and other API services required by the Injective Exchange Client. A partial specification for this API can be found at api.injective.dev.</p>
<h1 id='injective-evm-rpc-provider'>Injective EVM RPC provider</h1>
<p>Nodes also provide the full <a href="https://eth.wiki/json-rpc/API">Ethereum JSON-RPC API</a> which connects to the Injective EVM. </p>
<h1 id='injective-ethereum-bridge'>Injective ⮂ Ethereum Bridge</h1>
<p>Users can transfer ERC-20 tokens from Ethereum through the bi-directional Injective Token Bridge, which serves as a two-way Ethereum peg-zone for ERC-20 tokens to be transferred to the Injective Chain EVM. The peg-zone is based off <a href="https://github.com/cosmos/peggy">Peggy</a> and is secured by the Proof-of-Stake security of the Injective Chain. ERC-20 tokens can be transferred to and from Ethereum to the Injective Chain through the Injective Bridge . The process to do so is inspired by the standard flow as defined by Peggy.</p>

<p><strong>Ethereum → Injective Chain</strong></p>

<p>The following is the underlying process involved in transferring ERC-20 tokens from Ethereum to the Injective Chain. Validators witness the locking of ERC20 assets and sign a data package containing information about the lock, which is then relayed to the Injective chain and witnessed by the EthBridge module. Once a quorum of 2/3 of the validators by signing power have confirmed that the transaction&#39;s information is valid, the funds are released by the Oracle module and are transferred to the intended recipient&#39;s Cosmos address if a Cosmos address was specified in the lock event. The user can also choose to transfer the ERC-20 token to the corresponding child ERC-20 token on the Injective EVM chain.</p>

<p>This process is abstracted away from the end user, who simply needs to transfer their ERC-20 to the Injective Peg Zone contract and specify whether they desire to have their funds sent to their Cosmos address (represented in the Cosmos bank module) or on the child ERC-20 contract on the Injective EVM. </p>

<p><img src="images/inj-peg-c9229a81.png" alt="images/inj-peg-c9229a81.png" /></p>

<p>On a high level, the transfer flow for transferring a token to the is as follows:</p>

<ol>
<li>User sends the ERC-20 to the Injective Bridge Contract, emitting a LogLock event.</li>
<li>An Injective relayer listening to the event creates and signs a Tendermint transaction encoding this information which is then broadcasted to the Injective Chain.</li>
<li>The nodes of the Injective Chain verify the validity of the transaction.</li>
<li>New tokens representing the ERC-20 are minted in the <a href="https://docs.cosmos.network/master/modules/bank/">bank</a> module.</li>
</ol>

<p>Thereafter, the ERC-20 can be used on Injective Chain&#39;s EVM as well as in the Cosmos-SDK based application logic of the Injective Chain. In the future, the Injective chain will support cross-chain transfers using Cosmos IBC.</p>

<p><strong>Injective Chain → Ethereum</strong></p>

<p>The following is the underlying process involved in transferring ETH/ERC-20 tokens from the Injective Chain to Ethereum.</p>

<p>Validators witness transactions on the Injective Chain and sign a data package containing the information. The user&#39;s ETH/ERC-20 on the Injective Chain is burned, resulting in unlocking the ERC-20 on Ethereum. The data package containing the validator&#39;s signature is then relayed to the Injective Bridge contracts deployed on the Ethereum blockchain. Once enough other validators have confirmed that the transaction&#39;s information is valid, the funds are released/minted to the intended recipient&#39;s Ethereum address. </p>
<h1 id='token-economics'>Token Economics</h1>
<p>Injective transforms exchange into a fully decentralized public utility that’s <strong>owned and controlled by the community of INJ holders</strong>, as opposed to a single centralized entity. This community-driven philosophy underpins our entire protocol, where value is exclusively captured by the users and Injective token holders.</p>

<p>Injective Protocol&#39;s native token (INJ) is used for the following purposes:</p>
<h2 id='1-proof-of-stake-security'>1. Proof of Stake Security</h2>
<p>To ensure the security of our sidechain, we inflate the supply of our token to incentivize nodes to stake INJ and participate in the Injective network. </p>

<p>The tentative initial supply of INJ will be set to 100,000,000 tokens and shall increase for a finite amount of time through block rewards.</p>

<p>The target INJ inflation will tentatively be 7% at genesis and decrease over time to 2%. Over time, the total supply of INJ may be lower than the initial supply due to our deflationary mechanism detailed in the Exchange Fee Value Accrual section above.</p>
<h2 id='2-governance'>2.  Governance</h2>
<p>The INJ token can be used to govern various components of our sidechain including the futures protocol, exchange parameters and protocol upgrades.</p>

<p>The governance process for the Injective Chain core node is divided in a few steps that are outlined below:</p>

<ul>
<li><strong>Proposal submission:</strong> Proposal is submitted to the blockchain with a deposit.</li>
<li><strong>Vote:</strong> Once deposit reaches a certain value (<code>MinDeposit</code>), proposal is confirmed and vote opens. Bonded INJ holders can then send <code>TxGovVote</code> transactions to vote on the proposal.</li>
<li>If the proposal involves a software upgrade (as opposed to a Plain Text proposal):

<ul>
<li><strong>Signal:</strong> Validators start signaling that they are ready to switch to the new version.</li>
<li><strong>Switch:</strong> Once more than 75% of validators have signaled that they are ready to switch, their software automatically flips to the new version.</li>
</ul></li>
</ul>

<p>For any governance decision, INJ holders can initiate a referendum by submitting a signed on-chain proposal. Once at least 1% of the total supply of INJ token holders support the proposal, a 14-day referendum period will commence. During this time, INJ holders do not need to lock their tokens and can simply submit their vote on-chain. Their voting power, which is proportional to their token balance, will be calculated at the end of the 14-day period. After the voting window elapses, the proposal will only be accepted if a majority of voting power approve the proposal and if more than a predetermined percentage of the total token supply has participated in the election.</p>
<h2 id='3-market-maker-incentives'>3. Market Maker Incentives</h2>
<p>Make orders will receive a net positive fee rebate to incentivize liquidity. Distribution will happen periodically based on snapshots.</p>

<p>Our decentralized exchange will initially implement a global minimum exchange fee of $$r_m = 0.1 \%$$ for makers and $$r_t = 0.2\%$$ for takers.</p>

<p>As one mechanism of bootstrapping liquidity in the two-sided market of our decentralized exchange, we incentivize market makers to provide liquidity through exchange fee rebates in our INJ token. Traders who place make orders that are filled are proportionally rewarded (by $$\alpha_{filled}$$) with a filled make order rebate reward equal to:</p>

<p align="center">
$$\textbf{Filled Make Order Rebate} = \alpha_{filled} (\delta \cdot r_m)$$
</p>

<p>Where $$\delta$$ is the ratio between the market value of the reward and the exchange fee. The distribution of the INJ token will be done off-chain and a minimum threshold of the aggregate make order notional value for each address will be in place to qualify for the market maker incentive. At genesis, $$\delta$$ will be greater than 1 and slowly decrease to 0.5 in linear time over 4 years.</p>
<h2 id='4-relayer-incentives'>4. Relayer Incentives</h2>
<p>Nodes and validators of the Injective sidechain also have the capability to act as relayers who can cater to traders in their desired ways (e.g. a relayer can provide an improved interface/API catering to a specialized group of traders). As an incentive mechanism for relayers to provide the best experience for traders, we reward relayers who originate orders into the shared orderbook. The node that first discovers a make order (by relaying to the shared orderbook) will receive a ratio of the exchange fee of each make order discovered by them equal to the following:</p>

<p align="center">
$$\textbf{Make Order Relayer Reward} =  \beta_{make} (\delta \cdot r_m)$$
</p>

<p>Similarly, the node that first relays a take order will receive a ratio of the exchange fee of each make order discovered by them equal to the following:</p>

<p align="center">
$$\textbf{Take Order Relayer Reward} =  \beta_{take} (\delta \cdot r_t)$$
</p>

<p>At genesis, $$\delta$$ will be set at 40% and subject to change by governance.</p>
<h2 id='5-exchange-fee-value-accrual'>5. Exchange Fee Value Accrual</h2>
<p>After the relayer reward distribution, the rest of the exchange fee will undergo an on-chain buy-back-and-burn event to accrue value for INJ. Since it&#39;s not necessary for users to utilize INJ for the exchange fee, exchange fees collected from all trading pairs are aggregated over a set period of time and sold in batch to market makers who bid with INJ tokens. To achieve this, we utilize an absolute auction mechanism that repeats every month. A derivatives protocol contract will continuously aggregate all exchange fees collected during the monthly period into a pool and then conduct a week-long blind auction at the end of the period. The smart contract will simply verify and select the highest bid to conduct the exchange. All proceeds from the auction will be burnt.</p>
<h2 id='6-collateral-backing-for-derivatives'>6. Collateral Backing for Derivatives</h2>
<p>INJ will be utilized as an alternative to stablecoins as margin and collateral for Injective&#39;s derivatives markets. In some futures markets, INJ can also be used as collateral backing or insurance pool staking where stakers can earn interest on their locked tokens.</p>
<h2 id='7-exchange-participation-incentives'>7. Exchange participation incentives</h2>
<p>We plan to distribute a fixed number of INJ tokens daily over a predetermined period of time. Each day, a snapshot of all account profit-and-loss in selected markets will be taken. An aggregate profit-and-loss for the address will be calculated and used as the weight for token distribution. In practice, an avid Injective participant with high notional profit will receive more INJ than another participant with lower notional profit, even if he or she has a higher profit-and-loss percentage.</p>
<h1 id='derivatives-specification'>Derivatives Specification</h1><h2 id='overview'>Overview</h2>
<p>This protocol enables traders to create, enter into, and execute decentralized perpetual swap contracts on any arbitrary market.</p>

<p>Our design adopts an account balance model where all positions are publicly recorded with their respective accounts. Architecturally, the core logic is implemented on on-chain smart contracts while the order matching is done through on the Injective Chain (in an off-chain relay on-chain settlement fashion).</p>

<p>In our system, users have <strong>subaccounts</strong> which manage their <strong>positions</strong> in one or more futures <strong>markets.</strong> The first subaccount is treated as default account. Each futures market specifies the bilateral futures contract parameters and terms, including most notably the margin ratio and oracle. Buyers and sellers of contracts in a futures market coordinate off-chain and then enter into contracts through an on-chain transaction. At all times, the payout (NPV) of long positions are balanced with corresponding short positions. The positions held by an account are subject to liquidation when the NAV of the account becomes negative.</p>

<p>While a market is live, market-wide actions may affect all positions in the market such as dynamic funding rate adjustment (to balance market long/shorts) as well as clawbacks in rare scenarios.</p>
<h1 id='key-terms'>Key Terms</h1><h2 id='perpetual-swap'><strong>Perpetual Swap</strong></h2>
<p>A derivative providing exposure to the value of an underlying asset which mimics a margin-based spot market and has no expiry/settlement.</p>
<h2 id='cfd'><strong>CFD</strong></h2>
<p>Contract for difference which is a derivative stipulating that the sellers will pay the buyers the difference between the current value of an asset and its value at the contract&#39;s closing time.</p>
<h2 id='address'><strong>Address</strong></h2>
<p>A secp256k1 based address. It&#39;s important to differentiate an address from an account in the futures protocol.</p>
<h2 id='subaccount'><strong>Subaccount</strong></h2>
<p>An address can own one or more subaccounts which hold positions. Isolated margin positions are each held by their own subaccount while cross margined positions are held by the same account.</p>
<h2 id='deposits'><strong>Deposits</strong></h2>
<p>The value of an account&#39;s aggregate deposits denominated in a specified base currency (e.g. USDT).</p>
<h2 id='market'><strong>Market</strong></h2>
<p>A market is defined by its supported base currency, oracle, and minimum margin ratio / margin requirement. The market may also support a unique funding rates calculation, which is a distinctive feature of a perpetual swap futures market.</p>
<h2 id='direction'><strong>Direction</strong></h2>
<p>Long or Short.</p>
<h2 id='index-price'><strong>Index Price</strong></h2>
<p>The reference spot index price (<code>indexPrice</code>) of the underlying asset that the derivative contract derives from. This value is obtained from an oracle.</p>
<h2 id='contract-price'><strong>Contract Price</strong></h2>
<p>The value of the futures contract the position entered/created (<code>contractPrice</code>) or (<code>entryPrice</code>). This is purely market driven and is set by individuals, independent of the oracle price.</p>
<h2 id='execution-price'><strong>Execution Price</strong></h2>
<p>The execution price is the price of an executed trade. If the trader has no prior position, then <code>entryPrice</code> equals the <code>executionPrice</code>. Be aware that sometimes an <code>executionPrice</code> defined inside the order can differ slightly from the actual execution price when matching orders.</p>
<h2 id='quantity'><strong>Quantity</strong></h2>
<p>The quantity of contracts (<code>quantity</code>). Must be a whole number.</p>
<h2 id='position'><strong>Position</strong></h2>
<p>Executing a contract creates two opposing positions (one long and one short) which reflects the ownership conditions of some quantity of contracts.</p>

<p>A cross margined subaccount can hold multiple positions while an isolated margined subaccount holds one position.</p>
<h2 id='margin'><strong>Margin</strong></h2>
<p>Margin refers to the amount of base currency that a trader posts as collateral for a given position.</p>
<h2 id='contract'><strong>Contract</strong></h2>
<p>A contract refers to the single unit of subaccount for a position in a given direction in a given market. There are two sides of a contract (long or short) that one can enter into.</p>
<h2 id='order'><strong>Order</strong></h2>
<p>A cryptographically signed message expressing an unilateral agreement to enter into a position under certain specified terms (i.e. make order or take order).</p>
<h2 id='funding'><strong>Funding</strong></h2>
<p>Funding refers to the periodic payments exchanged between the traders that are long or short of a perpetual contract at the end of every funding epoch (e.g. every 8 hours). When the funding rate is positive, longs pay shorts. When negative, shorts pay longs.</p>
<h2 id='funding-rate'><strong>Funding Rate</strong></h2>
<p>The funding rate value determines the funding fee that positions pay and is based on the difference between the price of the contract in the perpetual swap markets and spot markets.</p>
<h2 id='funding-fee'><strong>Funding Fee</strong></h2>
<p>The funding fee <code>f_i</code> refers to the funding payment that is made for a <strong>single contract</strong> in the market for a given epoch <code>i</code>. When a position is created, the position records the current epoch which is noted as the <code>entry</code> epoch.</p>

<p>Cumulative funding <code>F</code> refers to the cumulative funding for the contract since position entry. <code>F_entry = f_entry + ... + f_current</code></p>
<h2 id='npv'><strong>NPV</strong></h2>
<p>Net Present Value of a single contract. For long and short perpetual contracts, the NPV calculation is:</p>

<ul>
<li><code>NPV_long = indexPrice - contractPrice - F_entry</code></li>
<li><code>NPV_short = - NPV_long = contractPrice - indexPrice + F_entry</code></li>
</ul>
<h2 id='nav'><strong>NAV</strong></h2>
<p>The Net Asset Value for an account. Equals the sum of the net position value over all of the account&#39;s positions.</p>

<p><code>NAV = sum(quantity * NPV + margin - quantity * indexPrice * maintenanceMarginRatio)</code></p>
<h2 id='liquidation'><strong>Liquidation</strong></h2>
<p>When an account&#39;s <strong>NAV</strong> becomes negative, all of its positions are subject to liquidation, i.e. the forced closure of the position due to a maintenance margin requirement being breached.</p>
<h2 id='vaporization'><strong>Vaporization</strong></h2>
<p>A subaccount is subject to vaporization when the subaccount is no longer possible to be liquidated with a net nonnegative payout which occurs when <code>NPV + margin &lt; 0</code>.</p>

<!-- ## **Liquidation Penalty**

The liquidation penalty (`liquidationPenalty`) is a fixed percentage defining the value of the liquidated position that is paid out. Each market can define its own liquidation penalty \(e.g. 3%\) but every market's liquidation penalty must be greater than the global minimum liquidation penalty.
 -->
<h2 id='maintenance-margin-requirement'><strong>Maintenance Margin Requirement</strong></h2>
<p>The maintenance margin requirement refers to the minimum amount of margin that a position must maintain after being established. If this requirement is breached, the position is subject to liquidation.</p>

<p>Throughout the lifetime of a position, each contract must satisfy the following margin requirement:</p>

<p><code>margin / quantity &gt;= indexPrice * maintenanceMarginRatio - NPV</code></p>
<h2 id='initial-margin-requirement'><strong>Initial Margin Requirement</strong></h2>
<p>When a position is first created, the amount of collateral supplied as margin must satisfy the initial margin requirement. This margin requirement is stricter than the maintenance margin requirement and exists in order to reduce the risk of immediate liquidation.</p>

<p><code>initialMarginRatio = maintenanceMarginRatio + initialMarginRatioFactor</code></p>

<p>Upon position creation, each contract must satisfy the following margin requirement:</p>

<p><code>margin / quantity &gt;= max(contractPrice * initialMarginRatio, indexPrice * initialMarginRatio - NPV</code></p>
<h2 id='liquidation-price'>Liquidation Price</h2>
<p>The liquidation price is the price at which a position can be liquidated and can be derived from the maintenance margin requirement formula.</p>

<p>For longs:</p>

<p><code>contractPrice = indexPrice - indexPrice * maintenanceMarginRatio + margin / quantity - F_entry</code></p>

<p>For shorts:</p>

<p><code>contractPrice = indexPrice + indexPrice * maintenanceMarginRatio - margin / quantity - F_entry</code></p>
<h2 id='clawback'><strong>Clawback</strong></h2>
<p>A clawback event occurs when a threshold number of accounts cannot be liquidated with a net-zero final payout. In practice, this happens when a chain reaction of unidirectional liquidation cannot be liquidated with the position margin due to volatility or lack of liquidity.</p>
<h2 id='leverage'><strong>Leverage</strong></h2>
<p>Although leverage is not explicitly defined in our protocol, the amount of margin a trader uses to collateralize a position is a function of leverage according to the following formula:</p>

<p><code>margin = quantity * max(contractPrice / leverage, indexPrice / leverage - NPV)</code></p>

<p>For new positions, the funding fee component of the NPV formula can be removed since the position has not been created yet, resulting in the following NPV calculations:</p>

<ul>
<li><code>NPV_long = indexPrice - contractPrice</code></li>
<li><code>NPV_short = contractPrice - indexPrice</code></li>
</ul>
<h1 id='make-orders'>Make Orders</h1>
<p>In the Injective Perpetuals Protocol, there are two main types of orders: maker orders and taker orders. <strong>Maker orders</strong> are stored on Injective&#39;s decentralized orderbook on the Injective Chain while <strong>Take orders</strong> are immediately executed against make orders on the Injective Perpetuals Contract.</p>

<p>Once a maker order is executed to create a position, the maker can also create <strong>stop loss</strong> and <strong>take profit</strong> orders.</p>
<h2 id='order-message-format'><strong>Order Message Format</strong></h2><div class="highlight"><pre class="highlight typescript tab-typescript"><code><span class="nx">How</span> <span class="nx">to</span> <span class="nx">create</span> <span class="nx">order</span> <span class="nx">within</span> <span class="nx">SDK</span>

<span class="kd">const</span> <span class="nx">limitOrder</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sdkClient</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nx">buildLimitOrder</span><span class="p">({</span>
  <span class="na">orderType</span><span class="p">:</span> <span class="nx">DerivativeOrderType</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span>
  <span class="na">marketId</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">makerAddress</span><span class="p">:</span> <span class="nx">fromAddress</span><span class="p">,</span>
  <span class="na">contractPrice</span><span class="p">:</span> <span class="k">new</span> <span class="nx">BigNumber</span><span class="p">(</span><span class="nx">fromWei</span><span class="p">(</span><span class="dl">"</span><span class="s2">1.7</span><span class="dl">"</span><span class="p">)),</span>
  <span class="na">leverage</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="c1">// subaccountNonce: 0 (0 = default)</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">stopLimitProfitDirectionOrder</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sdkClient</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nx">buildStopLimitOrder</span><span class="p">({</span>
  <span class="na">orderType</span><span class="p">:</span> <span class="nx">DerivativeOrderType</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span>
  <span class="na">isProfitDirection</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">marketId</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">makerAddress</span><span class="p">:</span> <span class="nx">fromAddress</span><span class="p">,</span>
  <span class="na">contractPrice</span><span class="p">:</span> <span class="k">new</span> <span class="nx">BigNumber</span><span class="p">(</span><span class="nx">fromWei</span><span class="p">(</span><span class="dl">"</span><span class="s2">1.9</span><span class="dl">"</span><span class="p">)),</span>
  <span class="na">leverage</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="na">triggerPrice</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">stopLimitLossDirectionOrder</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sdkClient</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nx">buildStopLimitOrder</span><span class="p">({</span>
  <span class="na">orderType</span><span class="p">:</span> <span class="nx">DerivativeOrderType</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span>
  <span class="na">isProfitDirection</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">marketId</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">makerAddress</span><span class="p">:</span> <span class="nx">fromAddress</span><span class="p">,</span>
  <span class="na">contractPrice</span><span class="p">:</span> <span class="k">new</span> <span class="nx">BigNumber</span><span class="p">(</span><span class="nx">fromWei</span><span class="p">(</span><span class="dl">"</span><span class="s2">1.5</span><span class="dl">"</span><span class="p">)),</span>
  <span class="na">leverage</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="na">triggerPrice</span><span class="p">:</span> <span class="mf">1.6</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">stopLossOrder</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sdkClient</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nx">buildStopLossOrder</span><span class="p">({</span>
  <span class="na">orderType</span><span class="p">:</span> <span class="nx">DerivativeOrderType</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span>
  <span class="na">marketId</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">makerAddress</span><span class="p">:</span> <span class="nx">fromAddress</span><span class="p">,</span>
  <span class="na">leverage</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="na">triggerPrice</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">takeProfitOrder</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sdkClient</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nx">buildStopLossOrder</span><span class="p">({</span>
  <span class="na">orderType</span><span class="p">:</span> <span class="nx">DerivativeOrderType</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span>
  <span class="na">marketId</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">makerAddress</span><span class="p">:</span> <span class="nx">fromAddress</span><span class="p">,</span>
  <span class="na">leverage</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="na">triggerPrice</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">closeOrder</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sdkClient</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nx">buildCloseOrder</span><span class="p">({</span>
  <span class="na">orderType</span><span class="p">:</span> <span class="nx">DerivativeOrderType</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span>
  <span class="na">marketId</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">makerAddress</span><span class="p">:</span> <span class="nx">fromAddress</span><span class="p">,</span>
  <span class="na">leverage</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="na">closePrice</span><span class="p">:</span> <span class="mf">2.1</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div><div class="highlight"><pre class="highlight shell tab-shell"><code>Examples of different orders

Limit Order Long
- makerAssetAmount <span class="o">(</span>executionPrice<span class="o">)</span>: 1.7
- takerAssetAmount <span class="o">(</span>quantity<span class="o">)</span>: 10
- makerFee <span class="o">(</span>margin<span class="o">)</span>: 50
- takerFee <span class="o">(</span>subaccount nonce<span class="o">)</span>: 0
- makerAssetData : 0xasd12f... <span class="o">(</span>market <span class="nb">id</span><span class="o">)</span>
- takerAssetData: 0x00000...
- makerFeeAssetData <span class="o">(</span>orderType<span class="o">)</span>: 0
- takerFeeAssetData <span class="o">(</span>triggerPrice<span class="o">)</span>: 0

Stop Limit Order Long Profit Direction
- makerAssetAmount <span class="o">(</span>executionPrice<span class="o">)</span>: 1.9
- takerAssetAmount <span class="o">(</span>quantity<span class="o">)</span>: 10
- makerFee <span class="o">(</span>margin<span class="o">)</span>: 50
- takerFee <span class="o">(</span>subaccount nonce<span class="o">)</span>: 0
- makerAssetData : 0xasd12f... <span class="o">(</span>market <span class="nb">id</span><span class="o">)</span>
- takerAssetData: 0x00000...
- makerFeeAssetData <span class="o">(</span>orderType<span class="o">)</span>: 1
- takerFeeAssetData <span class="o">(</span>triggerPrice<span class="o">)</span>: 1.8

Stop Limit Order Long Loss Direction
- makerAssetAmount <span class="o">(</span>executionPrice<span class="o">)</span>: 1.5
- takerAssetAmount <span class="o">(</span>quantity<span class="o">)</span>: 10
- makerFee <span class="o">(</span>margin<span class="o">)</span>: 50
- takerFee <span class="o">(</span>subaccount nonce<span class="o">)</span>: 0
- makerAssetData : 0xasd12f... <span class="o">(</span>market <span class="nb">id</span><span class="o">)</span>
- takerAssetData: 0x00000...
- makerFeeAssetData <span class="o">(</span>orderType<span class="o">)</span>: 2
- takerFeeAssetData <span class="o">(</span>triggerPrice<span class="o">)</span>: 1.6

Stop Loss Order Long
- makerAssetAmount <span class="o">(</span>executionPrice<span class="o">)</span>: 0
- takerAssetAmount <span class="o">(</span>quantity<span class="o">)</span>: 10
- makerFee <span class="o">(</span>margin<span class="o">)</span>: 0
- takerFee <span class="o">(</span>subaccount nonce<span class="o">)</span>: 5
- makerAssetData : 0xasd12f... <span class="o">(</span>market <span class="nb">id</span><span class="o">)</span>
- takerAssetData: 0x00000...
- makerFeeAssetData <span class="o">(</span>orderType<span class="o">)</span>: 3
- takerFeeAssetData <span class="o">(</span>triggerPrice<span class="o">)</span>: 1.4

Take Profit Order Long
- makerAssetAmount <span class="o">(</span>executionPrice<span class="o">)</span>: 0
- takerAssetAmount <span class="o">(</span>quantity<span class="o">)</span>: 10
- makerFee <span class="o">(</span>margin<span class="o">)</span>: 0
- takerFee <span class="o">(</span>subaccount nonce<span class="o">)</span>: 5
- makerAssetData : 0xasd12f... <span class="o">(</span>market <span class="nb">id</span><span class="o">)</span>
- takerAssetData: 0x00000...
- makerFeeAssetData <span class="o">(</span>orderType<span class="o">)</span>: 4
- takerFeeAssetData <span class="o">(</span>triggerPrice<span class="o">)</span>: 2.1

Close Order Long
- makerAssetAmount <span class="o">(</span>executionPrice<span class="o">)</span>: 1.4
- takerAssetAmount <span class="o">(</span>quantity<span class="o">)</span>: 10
- makerFee <span class="o">(</span>margin<span class="o">)</span>: 0
- takerFee <span class="o">(</span>subaccount nonce<span class="o">)</span>: 5
- makerAssetData : 0xasd12f... <span class="o">(</span>market <span class="nb">id</span><span class="o">)</span>
- takerAssetData: 0x00000...
- makerFeeAssetData <span class="o">(</span>orderType<span class="o">)</span>: 5
- takerFeeAssetData <span class="o">(</span>triggerPrice<span class="o">)</span>: 0
</code></pre></div>
<p>The Injective Perpetuals Protocol leverages the <a href="https://github.com/0xProject/0x-protocol-specification/blob/master/v3/v3-specification.md#order-message-format">0x Order Message format</a> for the external interface to represent a make order for a derivative position, i.e. a cryptographically signed message expressing an agreement to enter into a derivative position under specified parameters.</p>

<p>A make order message consists of the following parameters:</p>

<table><thead>
<tr>
<th style="text-align: left">0x Parameter</th>
<th style="text-align: left">Name</th>
<th style="text-align: left">Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">makerAddress</td>
<td style="text-align: left"><code>makerAddress</code></td>
<td style="text-align: left">address</td>
<td>Address that created the order.</td>
</tr>
<tr>
<td style="text-align: left">takerAddress</td>
<td style="text-align: left"><code>-</code></td>
<td style="text-align: left">address</td>
<td>Empty.</td>
</tr>
<tr>
<td style="text-align: left">feeRecipientAddress</td>
<td style="text-align: left"><code>feeRecipientAddress</code></td>
<td style="text-align: left">address</td>
<td>Address that will receive fees when order is filled.</td>
</tr>
<tr>
<td style="text-align: left">senderAddress</td>
<td style="text-align: left"><code>-</code></td>
<td style="text-align: left">address</td>
<td>Empty.</td>
</tr>
<tr>
<td style="text-align: left">makerAssetAmount</td>
<td style="text-align: left"><code>executionPrice</code></td>
<td style="text-align: left">uint256</td>
<td>The execution price, i.e. the price of one contract denominated in base currency for this order. Set to 0 for Stop Loss and Take Profit orders.</td>
</tr>
<tr>
<td style="text-align: left">takerAssetAmount</td>
<td style="text-align: left"><code>quantity</code></td>
<td style="text-align: left">uint256</td>
<td>The <code>quantity</code> of contracts the maker seeks to obtain.</td>
</tr>
<tr>
<td style="text-align: left">makerFee</td>
<td style="text-align: left"><code>margin</code></td>
<td style="text-align: left">uint256</td>
<td>The amount of margin denoted in base currency the maker would like to post/risk for the order. Set to 0 for Stop Loss and Take Profit orders.</td>
</tr>
<tr>
<td style="text-align: left">takerFee</td>
<td style="text-align: left"><code>subaccountNonce</code></td>
<td style="text-align: left">uint256</td>
<td>The desired account nonce to use for cross-margining. If set to 0, the default subaccount is used.</td>
</tr>
<tr>
<td style="text-align: left">expirationTimeSeconds</td>
<td style="text-align: left"><code>expirationTimeSeconds</code></td>
<td style="text-align: left">uint256</td>
<td>Timestamp in seconds at which order expires.</td>
</tr>
<tr>
<td style="text-align: left">salt</td>
<td style="text-align: left"><code>salt</code></td>
<td style="text-align: left">uint256</td>
<td>Arbitrary number to facilitate uniqueness of the order&#39;s hash.</td>
</tr>
<tr>
<td style="text-align: left">makerAssetData</td>
<td style="text-align: left"><code>marketIdLong</code></td>
<td style="text-align: left">bytes</td>
<td>The first 32 bytes contain the <code>marketID</code> of the market for the position if the order is LONG, empty otherwise. Right padded with 0&#39;s to be 36 bytes</td>
</tr>
<tr>
<td style="text-align: left">takerAssetData</td>
<td style="text-align: left"><code>marketIdShort</code></td>
<td style="text-align: left">bytes</td>
<td>The first 32 bytes contain the <code>marketID</code> of the market for the position if the order is SHORT, empty otherwise. Right padded with 0&#39;s to be 36 bytes</td>
</tr>
<tr>
<td style="text-align: left">makerFeeAssetData</td>
<td style="text-align: left"><code>orderType</code></td>
<td style="text-align: left">bytes</td>
<td>The bytes-encoded order type, see <a href="/#order-types">below</a> for available order types.</td>
</tr>
<tr>
<td style="text-align: left">takerFeeAssetData</td>
<td style="text-align: left"><code>triggerPrice</code></td>
<td style="text-align: left">bytes</td>
<td>The bytes-encoded trigger price for stop limit orders, stop loss orders and take profit orders. Empty for regular limit orders.</td>
</tr>
</tbody></table>

<p>In a given perpetual market specified by <code>marketID</code>, an order encodes the willingness to purchase <code>quantity</code> contracts in a given direction (long or short) at a specified executed price <code>executionPrice</code> using a specified amount of <code>margin</code> of base currency as collateral.</p>
<h3 id='order-types'>Order Types</h3>
<p>There are 6 different types of orders noted in the <code>makerFeeAssetData</code> field.</p>

<ol>
<li><strong>Limit Order</strong>: Regular Order to create a position with given quantity and contractPrice. (<code>makerFeeAssetData = 0</code>)</li>
<li><strong>Stop Limit Order Profit Direction</strong>: Limit order with given quantity and contractPrice that becomes only valid after the indexPrice has moved towards profit and is now at least the trigger price, i.e., for a Long indexPrice ≥ triggerPrice and for a Short indexPrice ≤ triggerPrice. (<code>makerFeeAssetData = 1</code>)</li>
<li><strong>Stop Limit Order Loss Direction</strong>: Limit order with given quantity and contractPrice that becomes only valid after the indexPrice has moved towards loss and is now at least the trigger price, i.e., for a Long indexPrice ≤ triggerPrice and for a Short indexPrice ≥ triggerPrice. (<code>makerFeeAssetData = 2</code>)</li>
<li><strong>Stop Loss Order</strong>: Order to close an existing position once the trigger price is reached towards the loss direction. (<code>makerFeeAssetData = 3</code>)</li>
<li><strong>Take Profit Order</strong>: Order to close an existing position once the trigger price is reached towards the profit direction. (<code>makerFeeAssetData = 4</code>)</li>
<li><strong>Close Order</strong>: Order to close an existing position with the given executionPrice, i.e., the closePrice. (<code>makerFeeAssetData = 5</code>)</li>
</ol>
<h2 id='isolated-and-cross-margin'>Isolated and Cross Margin</h2>
<p>In the derivatives space, margin refers to the amount needed to enter into a leveraged position. Initial and Maintenance Margin refer to the minimum initial amount needed to enter a position and the minimum amount needed to keep that position from getting liquidated. As various users have varying trading strategies, Injecive has employed two different methods of margining:</p>

<ul>
<li><strong>Cross Margin</strong>: Margin is shared between open positions in the same market.</li>
<li><strong>Isolated Margin</strong>: Margin assigned to a position is restricted to a certain amount. If the margin falls below the Maintenance Margin level, the position is liquidated. However, you can add and remove margin at will under this method.</li>
</ul>

<p>The Injective Perpetuals Protocol currently only supports cross-margining for positions in the same market by position netting.</p>

<p>To specify a cross-margined order, the order maker should specify the account he desires to use for cross-margining with the <strong>account nonce</strong> in the <code>takerFee</code> parameter which uniquely determines his <code>subAccountID</code>.</p>
<h2 id='stop-limit-order'>Stop Limit Order</h2>
<p>A Stop Limit Order is an order that cannot be executed until the market&#39;s index price reaches a certain Trigger Price as specified by the <code>takerFeeAssetData</code>.</p>

<p>Traders use this type of order for two main strategies:</p>

<ol>
<li>As a risk-management tool to limit losses on existing positions (a Stop Loss Limit Order), and</li>
<li>As an automatic tool to enter the market at a desired entry point without manually waiting for the market to place the order.</li>
</ol>

<p>For a <strong>long stop limit profit direction order</strong>, the order will only be able to be filled if the index price is greater than or equal to the trigger price.</p>

<p>For a <strong>short stop limit profit direction order</strong>, the order will only be able to be filled if the index price is less than or equal to the trigger price.</p>

<p><strong>Stop Limit Order Example</strong></p>
<div class="highlight"><pre class="highlight plaintext"><code>Quantity = 50 contracts
Contract Price = 9
Trigger Price = 10
Direction = Long
IsProfitDirection = True
</code></pre></div>
<p>In this example, the trader has selected a Stop Limit Long Order with a contract price of 9 and a trigger price of 10. This order will only be fillable when the index price exceeds 10. If the trader wants to increase the chances of his order being executed, he should set the his contract price higher (e.g. to 10.5).</p>
<h2 id='stop-loss-limit-order'>Stop Loss Limit Order</h2>
<p>To be a valid stop loss order, the position, which can be obtained for the given <code>subaccount nonce</code> and <code>marketID</code> must be owned by the maker, have the same <code>marketID</code>, have the opposite direction as the position and contractPrice used for order must not result in liquidating the existing position.</p>

<p>Note: Traders must have an active position to create a <strong>stop loss limit order</strong>. However, an active position is not needed for a pure <strong>stop limit order</strong>.</p>
<h2 id='take-profit-limit-order'>Take Profit Limit Order</h2>
<p>To be a valid take profit order, the position, which can be obtained for the given <code>subaccount nonce</code> and <code>marketID</code> must be owned by the maker and have the same <code>marketID</code>, have the opposite direction as the position.</p>
<h2 id='close-limit-order'>Close Limit Order</h2>
<p>To be a valid close order, the position, which can be obtained for the given <code>subaccount nonce</code> and <code>marketID</code> must be owned by the maker, have the same <code>marketID</code>, have the opposite direction as the position and contractPrice used for order must not result in liquidating the existing position.</p>

<p><em>Note: If the quantity of the **stop loss</em><em>, **take profit</em>* or <strong>close</strong> order is greater than the quantity of contracts in the position (e.g. after partial position closure), the maximum fillable quantity of the those limit order will be the total number of contracts of the position.*</p>
<h1 id='transaction-fees'>Transaction Fees</h1>
<p>The business model for traditional derivatives exchanges (e.g. BitMEX, Binance, FTX, etc.) is to take a transaction fee from the each trade. However, because Injective Protocol is designed as a fully decentralized network, we do not follow this approach.</p>

<p>Instead, transaction fees paid in Injective Protocol are used for two purposes.</p>

<ol>
<li>As compensation for relayers for driving liquidity to the protocol</li>
<li>As auction collateral for a &quot;buyback and burn&quot; process. In this token economic model, transaction fees collected over a fixed period of time (e.g. 2 weeks) are aggregated and then auctioned off to the public for the INJ token. The INJ received from this auction is then permanently burned.</li>
</ol>

<p>There are two types of transaction fees that should be introduced: <strong>maker fees</strong> (for limit or &quot;maker&quot; orders) and <strong>taker fees</strong> (for market or &quot;taker&quot; orders). For both maker and taker fees, transaction fees are to be extracted from the <strong>notional value</strong> of the trade.</p>
<h2 id='maker-fees'>Maker Fees</h2>
<p>Maker fees are fees that makers of limit orders pay. These are the fees paid by the order makers (found in the <code>makerAddress</code> parameter of each order). Limit orders (i.e. the orders from which maker fees apply) are <code>leftOrders</code> and <code>rightOrder</code> in the <code>multiMatchOrders</code> function, <code>orders</code> in the <code>marketOrders</code> function, <code>order</code> in the <code>fillOrder</code> function, <code>order</code> in the <code>closePosition</code> function, and <code>orders</code> in the <code>closePositionWithOrders</code> function.</p>

<p><strong>Notional Value of Maker Orders</strong></p>

<p>Recall that within a given perpetual market, an order encodes the willingness to purchase up to <code>quantity</code> contracts in a given direction (long or short) at a specified <code>contractPrice</code> using a specified amount of <code>margin</code> of base currency as collateral.</p>

<p>The notional value of a single contract is simply the <code>contractPrice</code> (or $P_{contract}$). Hence, the notional value of $n$ contracts is simply <code>n * contractPrice</code>. Note that orders can be partially filled so <code>n</code> must be less than or equal to <code>quantity</code>.</p>

<p>This the calculation for notional value that you will need to use for<code>leftOrders</code> and <code>rightOrder</code>* in <code>multiMatchOrders</code>, <code>orders</code> in the <code>marketOrders</code> function, <code>order</code> in the <code>fillOrder</code> function, <code>order</code> in the <code>closePosition</code> function, and <code>orders</code> in the <code>closePositionWithOrders</code> function.</p>

<ul>
<li>Note: the <code>contractPrice</code> for the <code>rightOrder</code> should be the weighted average <code>contractPrice</code> of the <code>leftOrders</code>.</li>
</ul>
<h2 id='taker-fees'>Taker Fees</h2>
<p>Taker fees are the fees paid by the <code>msg.sender</code> (the taker) in the <code>fillOrder</code> and <code>marketOrders</code> calls.</p>

<p><strong>Notional Value for Taker Orders</strong></p>

<p>The notional value calculation in <code>fillOrder</code> for the taker is simply <code>notional = quantity * contractPrice</code>.</p>

<p>The notional value calculation in <code>marketOrders</code> is the sum of the notional values for the quantity of contracts taken in each of the individual orders i.e. <code>notional = quantity_1 * contractPrice_1 + quantity_2 * contractPrice_2 + ... + quantity_n * contractPrice_n</code>. Note that $\sum \limits_{i=1}^{n} quantity_i$ must equal <code>quantity</code>.</p>

<p>The notional value calculation in <code>closePosition</code> and <code>closePositionWithOrders</code> for the taker (i.e. the closer/msg.sender) is <code>notional = quantity * avgContractPrice</code> (<code>avgContractPrice</code> is already defined in the contract).</p>

<p><strong>Maker Orders Transaction Fees</strong></p>

<p>Currently, whenever <code>n</code> contracts of a maker <code>order</code> are executed, the proportional amount of <code>margin</code> (where <code>margin = order.makerFee * n / order.takerAssetAmount</code>) is transferred from the user&#39;s base currency ERC-20 balance to the perpetuals contract.</p>

<p>With the introduction of the maker order fee, executing <code>n</code> contracts of the <code>order</code> should result in the trader to post <code>margin + txFee</code> where <code>txFee = notional * MAKER_FEE_PERCENT / 10000</code> where <code>notional = n * order.makerAssetAmount</code>and where <code>MAKER_FEE_PERCENT</code> refers to the digits of the maker fee percentage scaled by 10000 (i.e a 0.15% maker fee would be 15).</p>

<p><strong>Taker Orders Transaction Fees</strong></p>

<p>Similarly, with the introduction of the taker order fee, executing <code>n</code> contracts of the <code>order</code> should result in the trader posting <code>margin + txFee</code> where <code>txFee = notional * TAKER_FEE_PERCENT / 10000</code> where <code>TAKER_FEE_PERCENT</code> refers to the digits of the taker fee percentage scaled by 10000 (i.e a 0.25% taker fee would be 25) and where notional is described in the <strong>Notional Value for Taker Orders</strong> section.</p>

<p><strong>Transaction Fee Distribution</strong></p>

<p>For a given <code>order</code> with a transaction fee of <code>txFee</code>, if the <code>feeRecipientAddress</code> is defined, <code>txFee * RELAYER_FEE_PROPORTION / 100</code> should be distributed to the <code>feeRecipientAddress</code>&#39;s balance. and the remainder should be distributed to the auction contract&#39;s balance. Note: &quot;distributed to balance&quot; in this case does not mean an ERC-20 transfer but rather incrementing the recipient&#39;s internal balance in the perpetuals contract from which the recipient can withdraw from in the future (this withdrawal functionality already exists).</p>
<h2 id='order-validation'>Order Validation</h2><h3 id='getorderrelevantstate'>getOrderRelevantState</h3>
<p><code>getOrderRelevantState</code> can be used to validate an order before use with a given index price.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Fetches all order-relevant information needed to validate if the supplied order is fillable.
/// @param order The order structure
/// @param signature Signature provided by maker that proves the order's authenticity.
/// @param indexPrice The index price to use as a reference. If 0, use the market's existing index price.
/// @return The orderInfo (hash, status, and `takerAssetAmount` already filled for the given order),
/// fillableTakerAssetAmount (amount of the order's `takerAssetAmount` that is fillable given all on-chain state),
/// and isValidSignature (validity of the provided signature).
</span><span class="k">function</span> <span class="n">getOrderRelevantState</span><span class="p">(</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span> <span class="k">memory</span> <span class="n">order</span><span class="p">,</span>
    <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">indexPrice</span>
<span class="p">)</span>
    <span class="k">public</span>
    <span class="k">view</span>
    <span class="k">returns</span> <span class="p">(</span>
        <span class="n">LibOrder</span><span class="p">.</span><span class="n">DerivativeOrderInfo</span> <span class="k">memory</span> <span class="n">orderInfo</span><span class="p">,</span>
        <span class="kt">uint256</span> <span class="n">fillableTakerAssetAmount</span><span class="p">,</span>
        <span class="kt">bool</span> <span class="n">isValidSignature</span>
    <span class="p">)</span>
<span class="p">{</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>getOrderRelevantState</code> will perform the following steps:</p>

<ol>
<li>Set the hash of the <code>order</code> in <code>orderInfo.orderHash</code></li>
<li>Set the quantity of contracts of the <code>order</code> that have been filled in <code>orderInfo.orderTakerAssetFilledAmount</code></li>
<li>Set the order status of the order in <code>orderInfo.orderStatus</code> according to the following conditions:

<ol>
<li>If the order has been cancelled, the <code>orderStatus</code> will be <code>CANCELLED</code>.</li>
<li>If the order has been fully filled (i.e. <code>orderInfo.orderTakerAssetFilledAmount</code> equals <code>order.takerAssetAmount</code>, the <code>orderStatus</code> will be <code>FULLY_FILLED</code>.</li>
<li>If the order has expired, the <code>orderStatus</code> will be <code>EXPIRED</code>.</li>
<li>If the order&#39;s margin (<code>order.makerFee</code>) does not satisfy the <a href="#initial-margin-requirement">initial margin requirement</a>, the <code>orderStatus</code> will be <code>INVALID_MAKER_ASSET_AMOUNT</code>. Note: the index price used in this calculation is the inputted <code>indexPrice</code>.</li>
<li>Otherwise if the order is fillable, the <code>orderStatus</code> will be <code>FILLABLE</code> and the <code>fillableTakerAssetAmount</code> to equal the quantity of contracts that remain fillable (i.e. <code>order.takerAssetAmount - orderInfo.orderTakerAssetFilledAmount</code>).</li>
</ol></li>
<li>Check whether or not the signature is valid and set <code>isValidSignature</code> to true if valid. Otherwise, set to false and set the <code>orderStatus</code> to <code>INVALID</code>.</li>
<li>If the <code>orderStatus</code> from the previous steps is <code>FILLABLE</code>, check that the order maker has sufficient balance of baseCurrency in his subaccount deposits (his <code>availableMargin</code>) to fill <code>fillableTakerAssetAmount</code> contracts of the order.

<ul>
<li>If the maker does not have at least <code>order.makerFee * fillableTakerAssetAmount / order.takerAssetAmount + fillableTakerAssetAmount * order.makerAssetAmount * makerTxFee</code> amount of balance to the fill the order, <code>fillableTakerAssetAmount</code> is set to the maximum quantity of contracts fillable which equals <code>availableMargin * order.TakerAssetAmount / order.MakerFee + order.TakerAssetAmount * makerTxFee</code>. If this value is zero, the <code>orderStatus</code> will be <code>INVALID_TAKER_ASSET_AMOUNT</code>.</li>
</ul></li>
</ol>
<h3 id='getorderrelevantstates'>getOrderRelevantStates</h3>
<p><code>getOrderRelevantStates</code> can be used to validate multiple orders before use.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Fetches all order-relevant information needed to validate if the supplied orders are fillable.
/// @param orders Array of order structures
/// @param signatures Array of signatures provided by makers that prove the authenticity of the orders.
/// @return The ordersInfo (array of the hash, status, and `takerAssetAmount` already filled for each order),
/// fillableTakerAssetAmounts (array of amounts for each order's `takerAssetAmount` that is fillable given all on-chain state),
/// and isValidSignature (array containing the validity of each provided signature).
/// NOTE: Expects each of the orders to be of the same marketID, otherwise may potentially return relevant states for orders of differing marketID's using a stale price
</span><span class="k">function</span> <span class="n">getOrderRelevantStates</span><span class="p">(</span><span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span> <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span><span class="p">)</span>
  <span class="k">public</span>
  <span class="k">view</span>
  <span class="k">returns</span> <span class="p">(</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">DerivativeOrderInfo</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">ordersInfo</span><span class="p">,</span>
    <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">fillableTakerAssetAmounts</span><span class="p">,</span>
    <span class="kt">bool</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">isValidSignature</span>
    <span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<blockquote>
<p>DerivativeOrderInfo</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">DerivativeOrderInfo</span> <span class="p">{</span>
    <span class="n">OrderType</span> <span class="n">orderType</span><span class="p">;</span> <span class="c1">// The order type
</span>    <span class="n">OrderStatus</span> <span class="n">orderStatus</span><span class="p">;</span> <span class="c1">// Status that describes order's validity and fillability.
</span>    <span class="kt">bytes32</span> <span class="n">orderHash</span><span class="p">;</span> <span class="c1">// EIP712 typed data hash of the order (see LibOrder.getTypedDataHash).
</span>    <span class="kt">uint256</span> <span class="n">orderTakerAssetFilledAmount</span><span class="p">;</span> <span class="c1">// Amount of order that has already been filled.
</span>    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">;</span> <span class="c1">// The subaccountID associated with the order.
</span>    <span class="n">Types</span><span class="p">.</span><span class="n">Direction</span> <span class="n">direction</span><span class="p">;</span> <span class="c1">// The direction of the order
</span>    <span class="kt">bytes32</span> <span class="n">marketID</span><span class="p">;</span> <span class="c1">// The market ID of the order
</span>    <span class="kt">uint256</span> <span class="n">contractPrice</span><span class="p">;</span> <span class="c1">// The contract price of the order
</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Order Status</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">enum</span> <span class="n">OrderStatus</span> <span class="p">{</span>
    <span class="n">INVALID</span><span class="p">,</span> <span class="c1">// Default value
</span>    <span class="n">INSUFFICIENT_MARGIN_FOR_CONTRACT_PRICE</span><span class="p">,</span> <span class="c1">// Order does not have enough margin for contract price
</span>    <span class="n">INSUFFICIENT_MARGIN_FOR_INDEX_PRICE</span><span class="p">,</span> <span class="c1">// Order does not have enough margin for index price
</span>    <span class="n">FILLABLE</span><span class="p">,</span> <span class="c1">// Order is fillable
</span>    <span class="n">EXPIRED</span><span class="p">,</span> <span class="c1">// Order has already expired
</span>    <span class="n">FULLY_FILLED</span><span class="p">,</span> <span class="c1">// Order is fully filled
</span>    <span class="n">CANCELLED</span><span class="p">,</span> <span class="c1">// Order has been cancelled
</span>    <span class="n">UNFUNDED</span><span class="p">,</span> <span class="c1">// Maker of the order does not have sufficient funds deposited to be filled.
</span>    <span class="n">UNTRIGGERED</span><span class="p">,</span> <span class="c1">// Index Price has not been triggered
</span>    <span class="n">INVALID_TRIGGER_PRICE</span><span class="p">,</span> <span class="c1">// TakeProfit trigger price is lower than contract price or StopLoss trigger price is higher than contract price
</span>    <span class="n">LIQUIDATED</span> <span class="c1">// Close price is causing liquidation for CLOSE or STOP_LOSS
</span><span class="p">}</span>
</code></pre></div><h2 id='cancelorder'>cancelOrder</h2><div class="highlight"><pre class="highlight plaintext"><code>/// @dev Cancels the input order
/// @param order the order to cancel
function cancelOrder(LibOrder.Order calldata order) external;
</code></pre></div><h1 id='take-orders'>Take Orders</h1>
<p>Orders can be filled by calling the following methods on the <code>InjectiveFutures</code> contract</p>
<h2 id='fillorder'>fillOrder</h2>
<p>This is the most basic way to fill an order. All of the other methods call <code>fillOrder</code> under the hood with additional logic. This function will attempt to execute <code>quantity</code> contracts of the <code>order</code> specified by the caller. However, if the remaining fillable amount is less than the <code>quantity</code> specified, the remaining amount will be filled. Partial fills are allowed when filling orders.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Fills the input order.
/// @param order The make order to be executed.
/// @param quantity Desired quantity of contracts to execute.
/// @param margin Desired amount of margin (denoted in baseCurrency) to use to fill the order.
/// @param subAccountID The subAccountID of the account for the taker to cross-margin with.
/// @param signature The signature of the order signed by maker.
/// @return fillResults
</span><span class="k">function</span> <span class="n">fillOrder</span><span class="p">(</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span> <span class="k">memory</span> <span class="n">order</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">margin</span><span class="p">,</span>
    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">,</span>
    <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span> <span class="k">memory</span><span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>fillOrder</code> will perform the following steps:</p>

<ol>
<li>Query the oracle to obtain the most recent price and funding fee.</li>
<li>Query the state and status of the order with <a href="#getorderrelevantstate"><code>getOrderRelevantState</code></a>.</li>
<li>Revert if the orderStatus is not <code>FILLABLE</code>.</li>
<li>Create the Maker&#39;s Position.

<ol>
<li>If the order has been used previously, execute funding payments on the existing position and then update the existing position state. Otherwise, create a new account with a corresponding new position for the maker and log a <code>FuturesPosition</code> event.</li>
<li>Transfer <code>fillResults.makerMarginUsed + fillResults.feePaid</code> of base currency from the maker to the contract to create (or add to) the maker&#39;s position.</li>
<li>Allocate <code>fillResults.makerMarginUsed</code> for the new position margin and allocate <code>relayerFeePercentage</code> of the <code>fillResults.makerFeePaid</code> to the fee recipient (if specified) and the remaining <code>fillResults.feePaid</code> to the insurance pool.</li>
</ol></li>
<li>Create the Taker&#39;s position.

<ol>
<li>Create a new account with a corresponding new position for the taker and log a <code>FuturesPosition</code> event.</li>
<li>Transfer <code>margin + fillResults.takerFeePaid</code> of base currency from the taker to the contract to create the taker&#39;s position.</li>
<li>Allocate <code>margin</code> for the new position margin and allocate <code>relayerFeePercentage</code> of the <code>fillResults.takerFeePaid</code> to the fee recipient (if specified) and the remaining <code>fillResults.takerFeePaid</code> to the insurance pool.</li>
</ol></li>
</ol>
<h2 id='fillorkillorder'>fillOrKillOrder</h2>
<p><code>fillOrKillOrder</code> can be used to fill an order while guaranteeing that the specified amount will either be filled or the call will revert.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Fills the input order. Reverts if exact quantity not filled
/// @param order The make order to be executed.
/// @param quantity Desired quantity of contracts to execute.
/// @param margin Desired amount of margin (denoted in baseCurrency) to use to fill the order.
/// @param subAccountID The subAccountID of the account for the taker to cross-margin with.
/// @param signature The signature of the order signed by maker.
/// return results The fillResults
</span><span class="k">function</span> <span class="n">fillOrKillOrder</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span> <span class="k">memory</span> <span class="n">order</span><span class="p">,</span>
  <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
  <span class="kt">uint256</span> <span class="n">margin</span><span class="p">,</span>
  <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">signature</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span> <span class="k">memory</span> <span class="n">fillResults</span><span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>fillOrKillOrder</code> will perform the following steps:</p>

<ol>
<li>Call <code>_fillOrder</code> with the passed in inputs</li>
<li>Revert if <code>fillResults.quantityFilled</code> does not equal the passed in <code>quantity</code></li>
</ol>
<h2 id='batchfillorders'>batchFillOrders</h2>
<p><code>batchFillOrders</code> can be used to fill multiple orders in a single transaction.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Executes multiple calls of fillOrder.
/// @param orders The make order to be executed.
/// @param quantities Desired quantity of contracts to execute.
/// @param margins Desired amount of margin (denoted in baseCurrency) to use to fill the order.
/// @param subAccountIDs The subAccountIDs of the accounts for the taker to cross-margin with.
/// @param signatures The signature of the order signed by maker.
/// return results The fillResults
</span><span class="k">function</span> <span class="n">batchFillOrders</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">quantities</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">margins</span><span class="p">,</span>
  <span class="kt">bytes32</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">subAccountIDs</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>batchFillOrders</code> will perform the following steps:</p>

<ol>
<li>Sequentially call <code>fillOrder</code> for each element of <code>orders</code>, passing in the order, fill amount, and signature at the same index.</li>
</ol>
<h2 id='batchfillorkillorders'>batchFillOrKillOrders</h2>
<p><code>batchFillOrKillOrders</code>can be used to fill multiple orders in a single transaction while guaranteeing that the specified amounts will either be filled or the call will revert.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Executes multiple calls of fillOrKill orders.
/// @param orders The make order to be executed.
/// @param quantities Desired quantity of contracts to execute.
/// @param margins Desired amount of margin (denoted in baseCurrency) to use to fill the order.
/// @param subAccountIDs The subAccountIDs of the accounts for the taker to cross-margin with.
/// @param signatures The signature of the order signed by maker.
/// return results The fillResults
</span><span class="k">function</span> <span class="n">batchFillOrKillOrders</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">quantities</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">margins</span><span class="p">,</span>
  <span class="kt">bytes32</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">subAccountIDs</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>batchFillOrKillOrders</code> will perform the following steps:</p>

<ol>
<li>Sequentially call <code>fillOrder</code> for each element of <code>orders</code>, passing in the order, fill amount, and signature at the same index.</li>
<li>Revert if any of the <code>fillOrder</code> calls do not fill the entire quantity passed.</li>
</ol>
<h2 id='batchfillorderssingleposition'>batchFillOrdersSinglePosition</h2>
<p><code>batchFillOrdersSinglePosition</code> can be used to fill multiple orders in a single transaction while creating just one opposing position for the taker.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Executes multiple calls of fillOrder but creates only one position for the taker.
/// @param orders The make order to be executed.
/// @param quantities Desired quantity of contracts to execute.
/// @param margins Desired amount of margin (denoted in baseCurrency) to use to fill the order.
/// @param subAccountID The subAccountID of the account for the taker to cross-margin with.
/// @param signatures The signature of the order signed by maker.
/// return results The fillResults
</span><span class="k">function</span> <span class="n">batchFillOrdersSinglePosition</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">quantities</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">margins</span><span class="p">,</span>
  <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>batchFillOrdersSinglePosition</code> will perform the same steps as <code>batchFillOrders</code> but will reuse the same taker position to create the opposing position for each order.</p>
<h2 id='batchfillorkillorderssingleposition'>batchFillOrKillOrdersSinglePosition</h2>
<p><code>batchFillOrKillOrdersSinglePosition</code> can be used to</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Executes batchFillOrKillOrders but creates only one position for the taker.
/// @param orders The make order to be executed.
/// @param quantities Desired quantity of contracts to execute.
/// @param margins Desired amount of margin (denoted in baseCurrency) to use to fill the order.
/// @param subAccountID The subAccountID of the account for the taker to cross-margin with.
/// @param signatures The signature of the order signed by maker.
/// return results The fillResults
</span><span class="k">function</span> <span class="n">batchFillOrKillOrdersSinglePosition</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">quantities</span><span class="p">,</span>
  <span class="kt">uint256</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">margins</span><span class="p">,</span>
  <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>batchFillOrKillOrdersSinglePosition</code> will perform the same steps as <code>batchFillOrdersSinglePosition</code> but will revert if each of the quantities specified is not filled.</p>
<h2 id='marketorders'><strong>marketOrders</strong></h2>
<p><code>marketOrders</code> can be used to can be used to purchase a specified quantity of contracts of a derivative by filling multiple orders while guaranteeing that no individual fill throws an error. Note that this function does not enforce that the entire quantity is filled. The input orders should be sorted from best to worst price.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev marketOrders executes the orders until the desired `quantity` is reached
/// @param orders Array of order specifications.
/// @param quantity Desired quantity of contracts to execute.
/// @param margin Desired amount of margin (denoted in baseCurrency) to use to fill the orders.
/// @param subAccountID The subAccountID of the account for the taker to cross-margin with.
/// @param signatures Proofs that orders have been signed by makers.
</span><span class="k">function</span> <span class="n">marketOrders</span><span class="p">(</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">margin</span><span class="p">,</span>
    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">,</span>
    <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="n">nonReentrant</span> <span class="n">whenNotPaused</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>marketOrders</code> will perform the following steps:</p>

<ol>
<li>Sequentially call <code>fillOrder</code> while decrementing the <code>quantity</code> and <code>margin</code> executed after each fill until the quantity is fully filled, the margin is exhausted, or all of the orders have been executed.</li>
</ol>
<h2 id='marketordersorkill'><strong>marketOrdersOrKill</strong></h2>
<p><code>marketOrders</code> can be used to can be used to purchase a specified quantity of contracts of a derivative by filling multiple orders while guaranteeing that no individual fill throws an error. Note that this function enforces that the entire quantity is filled. The input orders should be sorted from best to worst price.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev marketOrdersOrKill performs the same steps as `marketOrders` but reverts if the inputted `quantity` of contracts are not filled
/// @param orders Array of order specifications.
/// @param quantity Desired quantity of contracts to execute.
/// @param margin Desired amount of margin (denoted in baseCurrency) to use to fill the orders.
/// @param subAccountID The subAccountID of the account for the taker to cross-margin with.
/// @param signatures Proofs that orders have been signed by makers.
</span><span class="k">function</span> <span class="n">marketOrdersOrKill</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
  <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
  <span class="kt">uint256</span> <span class="n">margin</span><span class="p">,</span>
  <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="n">FillResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>marketOrdersOrKill</code> will perform the same steps as <code>marketOrders</code> but will revert if the entire <code>quantity</code> is not filled.</p>
<h1 id='matching-orders'>Matching Orders</h1>
<p>Two orders of opposing directions can directly be matched if they have a negative spread.</p>
<h2 id='matchorders'>matchOrders</h2>
<p><code>matchOrders</code> can be used to atomically fill 2 orders without requiring the taker to hold any capital. This function is optimized for creator of the <code>rightOrder</code>.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Matches the input orders.
/// @param leftOrder The order to be settled.
/// @param rightOrder The order to be settled.
/// @param leftSignature The signature of the order signed by maker.
/// @param rightSignature The signature of the order signed by maker.
</span><span class="k">function</span> <span class="n">matchOrders</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span> <span class="k">memory</span> <span class="n">leftOrder</span><span class="p">,</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span> <span class="k">memory</span> <span class="n">rightOrder</span><span class="p">,</span>
  <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">leftSignature</span><span class="p">,</span>
  <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">rightSignature</span>
<span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>matchOrders</code> will perform the following steps: TODO</p>
<h2 id='multimatchorders'>multiMatchOrders</h2>
<p><code>multiMatchOrders</code> can be used to match a set of orders with another opposing order with negative spread, resulting in the creation of just one position for the creator of the <code>rightOrder</code>. This function is optimized for creator of the <code>rightOrder</code>.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Matches the input orders and only creates one position for the `rightOrder` maker.
/// @param leftOrders The orders to be settled.
/// @param rightOrder The order to be settled.
/// @param leftSignatures The signatures of the order signed by maker.
/// @param rightSignature The signature of the order signed by maker.
</span><span class="k">function</span> <span class="n">multiMatchOrders</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">leftOrders</span><span class="p">,</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span> <span class="k">memory</span> <span class="n">rightOrder</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">leftSignatures</span><span class="p">,</span>
  <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">rightSignature</span>
<span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>multiMatchOrders</code> will sequentially call <code>matchOrders</code>.</p>
<h2 id='batchmatchorders'>batchMatchOrders</h2>
<p><code>batchMatchOrders</code> can be used to match 2 sets of an arbitrary number of orders with each other using the same matching strategy as <a href="https://github.com/0xProject/0x-protocol-specification/blob/master/v3/v3-specification.md#matchorders"><code>matchOrders</code></a>.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Matches the input orders.
/// @param leftOrders The orders to be settled.
/// @param rightOrder The order to be settled.
/// @param leftSignatures The signatures of the order signed by maker.
/// @param rightSignature The signature of the order signed by maker.
</span><span class="k">function</span> <span class="n">batchMatchOrders</span><span class="p">(</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">leftOrders</span><span class="p">,</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">rightOrders</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">leftSignatures</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">rightSignatures</span>
<span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>batchMatchOrders</code> will sequentially call <code>matchOrders</code>.</p>
<h1 id='positions'>Positions</h1><h2 id='closeposition'>closePosition</h2><div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Closes the input position.
/// @param positionID The positionID of the position being closed
/// @param orders The orders to use to settle the position
/// @param quantity The quantity of contracts being used in the order
/// @param signatures The signatures of the orders signed by makers.
</span><span class="k">function</span> <span class="n">closePosition</span><span class="p">(</span>
    <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">,</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
    <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="p">(</span><span class="n">PositionResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">pResults</span><span class="p">,</span> <span class="n">CloseResults</span> <span class="k">memory</span> <span class="n">cResults</span><span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>closePosition</code> will perform the following steps:</p>

<ol>
<li>Query the oracle to obtain the most recent price and funding fee.</li>
<li>Execute funding payments on the existing position and then update the existing position state.</li>
<li>Check that the existing <code>position</code> (referenced by <code>positionID</code>) is valid and can be closed.</li>
<li>Create the Makers&#39; Positions.

<ol>
<li>For each order <code>i</code>:</li>
<li>If the order has been used previously, execute funding payments on the existing position and then update the existing position state. Otherwise, create a new account with a corresponding new position with the <code>pResults[i].quantity</code> contracts for the maker and log a <code>FuturesPosition</code> event.</li>
<li>Transfer <code>pResults[i].marginUsed + pResults[i].fee</code> of base currency from the maker to the contract to create (or add to) the maker&#39;s position.</li>
<li>Allocate <code>pResults.marginUsed</code> for the new position margin and allocate <code>relayerFeePercentage</code> of the <code>pResults.fee</code> to the fee recipient (if specified) and the remaining <code>pResults.fee</code> to the insurance pool.</li>
</ol></li>
<li>Close the <code>cResults.quantity</code> quantity conracts of the existing position.

<ol>
<li>Calculate the PNL per contract (<code>contractPNL</code>) which equals <code>averageClosingPrice - position.contractPrice</code> for longs and <code>position.contractPrice - averageClosingPrice</code> for shorts, where:

<ul>
<li><code>averageClosingPrice = (orders[i].contractPrice * results[0].quantity + orders[n-1].contractPrice * results[n-1].quantity)/(cResults.quantity)</code></li>
<li><code>cResults.quantity = results[0].quantity + ... + results[n-1].quantity</code> . Note that <code>cResults.quantity &lt;= quantity</code>.</li>
</ul></li>
<li>Transfer <code>cResults.payout</code> to the owner of the <code>position</code> and update the position state.

<ul>
<li><code>cResults.payout = cResults.quantity * (position.margin / position.quantity + contractPNL)</code></li>
</ul></li>
<li>Log a <code>FuturesClose</code> event.</li>
</ol></li>
</ol>
<h2 id='closepositionorkill'>closePositionOrKill</h2><div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Closes the input position and revert if the entire `quantity` of contracts cannot be closed.
/// @param positionID The positionID of the position being closed
/// @param orders The orders to use to settle the position
/// @param quantity The quantity of contracts being used in the order
/// @param signatures The signatures of the orders signed by makers.
</span><span class="k">function</span> <span class="n">closePositionOrKill</span><span class="p">(</span>
  <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">,</span>
  <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
  <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
  <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="n">PositionResults</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">pResults</span><span class="p">,</span> <span class="n">CloseResults</span> <span class="k">memory</span> <span class="n">cResults</span><span class="p">);</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>closePositionOrKill</code> will perform the same steps as <code>closePosition</code> but will revert if the entire <code>quantity</code> of contracts inputted cannot be closed.</p>
<h1 id='liquidation-2'>Liquidation</h1><h2 id='liquidatepositionwithorders'>liquidatePositionWithOrders</h2><div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Liquidates the position.
/// @param positionID The ID of the position to liquidate.
/// @param quantity The quantity of contracts of the position to liquidate.
/// @param orders The orders to use to liquidate the position.
/// @param signatures The signatures of the orders signed by makers.
</span><span class="k">function</span> <span class="n">liquidatePosition</span><span class="p">(</span>
    <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">,</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
    <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="n">nonReentrant</span> <span class="n">whenNotPaused</span> <span class="k">returns</span> <span class="p">(</span><span class="n">PositionResults</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div>
<p><strong>Logic</strong></p>

<p>Calling <code>liquidatePosition</code> will perform the following steps:</p>

<ol>
<li>Query the oracle to obtain the most recent price and funding fee.</li>
<li>Execute funding payments on the existing position and then update the existing position state.</li>
<li>Check that the existing <code>position</code> (referenced by <code>positionID</code>) is valid and can be liquidated (i.e. that the <a href="#maintenance-margin-requirement">maintenance margin requirement</a> is breached.</li>
<li><p>Create the Makers&#39; Positions.</p>

<ol>
<li>For each order <code>i</code>:

<ol>
<li>If the order has been used previously, execute funding payments on the existing position and then update the existing position state. Otherwise, create a new account with a corresponding new position with the <code>pResults[i].quantity</code> contracts for the maker and log a <code>FuturesPosition</code> event.`</li>
<li>Transfer <code>pResults[i].marginUsed + pResults[i].fee</code> of base currency from the maker to the contract to create (or add to) the maker&#39;s position.</li>
<li>Allocate <code>pResults.marginUsed</code> for the new position margin and allocate <code>relayerFeePercentage</code> of the <code>pResults.fee</code> to the fee recipient (if specified) and the remaining <code>pResults.fee</code> to the insurance pool.</li>
</ol></li>
<li><code>lResults.quantity</code> equals the total quantity of contracts created across the orders from the previous step, i.e. <code>lResults.quantity = pResults[0].quantity + ... + pResults[n-1].quantity</code> . Note that <code>lResults.quantity &lt;= quantity</code>.</li>
<li><code>lResults.liquidationPrice</code> equals the weighted average price, i.e. <code>lResults.liquidationPrice = (orders[i].contractPrice * pResults[0].quantity + orders[n-1].contractPrice * pResults[n-1].quantity)/(lResults.quantity)</code>

<ul>
<li>To liquidate a long position, <code>lResults.liquidationPrice</code> must be greater than or equal to the index price.</li>
<li>To liquidate a short position, <code>lResults.liquidationPrice</code> must be less than or equal to the index price.</li>
</ul></li>
</ol></li>
<li><p>Close the <code>lResults.quantity</code> quantity contracts of the existing position.</p>

<ol>
<li>Calculate the trader&#39;s loss (<code>position.margin / position.quantity * quantity</code>) and update the state of the trader&#39;s position.</li>
<li>Calculate the PNL per contract (<code>contractPNL</code>) which equals <code>lResults.liquidationPrice - position.contractPrice</code> for longs and <code>position.contractPrice - averageClosingPrice</code> for shorts.</li>
<li>Calculate the total payout from the position<code>cResults.payout = cResults.quantity * (position.margin / position.quantity + contractPNL)</code>

<ol>
<li>Allocate half of the payout to the liquidator and half to the insurance fund</li>
</ol></li>
<li>Decrement the position&#39;s remaining margin by <code>position.margin / position.quantity * (position.quantity - quantity)</code></li>
<li>Emit a <code>FuturesLiquidation</code> event.</li>
</ol></li>
</ol>
<h2 id='vaporization-2'>Vaporization</h2><h2 id='vaporizeposition'>vaporizePosition</h2><div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="c1">/// @dev Vaporizes the position.
/// @param positionID The ID of the position to vaporize.
/// @param quantity The quantity of contracts of the position to vaporize.
/// @param orders The orders to use to vaporize the position.
/// @param signatures The signatures of the orders signed by makers.
</span><span class="k">function</span> <span class="n">vaporizePosition</span><span class="p">(</span>
    <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">,</span>
    <span class="n">LibOrder</span><span class="p">.</span><span class="n">Order</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">orders</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
    <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span>
<span class="p">)</span> <span class="k">external</span> <span class="n">nonReentrant</span> <span class="n">whenNotPaused</span> <span class="k">returns</span> <span class="p">(</span><span class="n">PositionResults</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div><h1 id='oracle'>Oracle</h1><h2 id='general-concept'>General concept</h2>
<p>The oracle serves one function:</p>

<ol>
<li>Update the index price of an asset</li>
</ol>
<h3 id='1-update-the-index-price'>1. Update the index price</h3>
<p>The index price is used to calculate the NPV of positions. It will be periodically updated by the oracle.</p>
<h2 id='funding-fee-2'>Funding Fee</h2>
<p>The funding fee is a critical piece to ensure convergence of market prices to the real underlying asset price. It consists of two components:</p>

<ol>
<li>Index Price: The price provided by the oracle.</li>
<li>Futures VWAP: The VWAP (Volume Weighted Average Price), which emerges from the trades in injective futures and the indexPrice. It is same with VWAP if the price is changed                    to <code>(futuresPrice - indexPrice) / indexPrice</code>.</li>
</ol>
<h3 id='vwap'>VWAP</h3>
<p>The VWAP calculation consists of two components:</p>

<ol>
<li>Price: The price of the trade.</li>
<li>Quantity: The quantity of contracts that got settled in the trade.</li>
</ol>

<p>The VWAP calculation formula is the following:</p>

<p><code>VWAP = ∑(price * quantity) / ∑quantity</code></p>

<p>If price is changed with the one mentioned above:</p>

<p><code>FuturesVWAP = ∑[(futuresPrice - indexPrice) / indexPrice) * quantity] / ∑quantity</code></p>
<h3 id='futures-vwap-update'>Futures VWAP update</h3>
<p>To calculate futures VWAP, there are three cases, where <code>volume</code> and <code>totalQuantity</code> should be updated:</p>

<ol>
<li>On order filling.</li>
<li>On order matching.</li>
<li>On position closing.</li>
</ol>

<p>In those 3 cases, <code>_updateValuesForVWAP</code> function is called.</p>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">function</span> <span class="n">_updateValuesForVWAP</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="n">marketID</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">contractPrice</span>
<span class="p">)</span> <span class="k">internal</span>
</code></pre></div><h3 id='calculation'>Calculation</h3>
<p>The funding fee formula is the following:</p>

<p><code>FundingFee = FuturesVWAP / (24 / fundingInterval)</code></p>

<p>, where <code>fundingInterval</code> may differ between markets and it represents how often the funding fee is applied.</p>
<h2 id='testnet-setup'>Testnet setup</h2>
<p>For the testnet we are setting up a centralized oracle service. In later versions this will be replaced by a decentralized mechanism.</p>
<h3 id='testnet-pairs'>Testnet pairs</h3>
<p>-XAU/USDT
-ETH/USDT
-UNI/USDT
-YFI/USDT
-DOT/USDT
-BTC/USDT
-EGLD/USDT
-LINK/USDT
-BNB/USDT</p>

<p>For all market pairs the <code>fundingInterval</code> is 1 hour.</p>

<p>That means that funding fees are applied every hour between all positions of a market.</p>
<h3 id='oracle-services'>Oracle services</h3>
<p>Prices in all markets are updated by oracle service every 10 seconds, except <code>XAU/USDT</code> pair where the price is updated every 5 minutes.</p>

<p>If any asynchronous requests fail, we deploy an <a href="https://cloud.google.com/iot/docs/how-tos/exponential-backoff">exponential backoff</a> strategy.</p>

<p>For <code>XAU/USDT</code> price is taken from <a href="https://metals-api.com/">https://metals-api.com/</a>.</p>

<p>For all other pairs prices are taken from binance API.
Example for <code>ETH/USDT</code> pair: [https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT].</p>
<h1 id='events'>Events</h1><h2 id='injectivefutures-contract-events'>InjectiveFutures Contract Events</h2>
<blockquote>
<p>FuturesPosition</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">FuturesPosition</span><span class="p">(</span>
    <span class="kt">address</span> <span class="k">indexed</span> <span class="n">makerAddress</span><span class="p">,</span> <span class="c1">// Address that created the order.
</span>    <span class="kt">bytes32</span> <span class="n">accountId</span><span class="p">,</span> <span class="c1">// subaccount id that created the order.
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">orderHash</span><span class="p">,</span> <span class="c1">// EIP712 hash of order (see LibOrder.getTypedDataHash).
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// Market ID
</span>    <span class="kt">uint256</span> <span class="n">contractPrice</span><span class="p">,</span> <span class="c1">// Price of the contract
</span>    <span class="kt">uint256</span> <span class="n">quantityFilled</span><span class="p">,</span> <span class="c1">// quantity of contracts added
</span>    <span class="kt">uint256</span> <span class="n">totalQuantity</span><span class="p">,</span> <span class="c1">// total quantity of contracts in position
</span>    <span class="kt">int256</span> <span class="n">cumulativeFundingEntry</span><span class="p">,</span> <span class="c1">// cum. funding at position start
</span>    <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">,</span> <span class="c1">// positionID
</span>    <span class="kt">bool</span> <span class="n">isLong</span> <span class="c1">// true if long, false if short
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>FuturesNettedPosition</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">FuturesNettedPosition</span><span class="p">(</span>
    <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">,</span> <span class="c1">// positionID
</span>    <span class="kt">bytes32</span> <span class="n">subAccountId</span><span class="p">,</span> <span class="c1">// subaccount id that created the order.
</span>    <span class="kt">address</span> <span class="k">indexed</span> <span class="n">makerAddress</span><span class="p">,</span> <span class="c1">// Address that created the order.
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// Market ID
</span>    <span class="kt">uint256</span> <span class="n">margin</span><span class="p">,</span> <span class="c1">// new margin of netted position
</span>    <span class="kt">uint256</span> <span class="n">contractPrice</span><span class="p">,</span> <span class="c1">// new contract price of netted position
</span>    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span> <span class="c1">// new quantity of of netted position
</span>    <span class="kt">int256</span> <span class="n">cumulativeFundingEntry</span><span class="p">,</span> <span class="c1">// new cumululative funding
</span>    <span class="kt">bool</span> <span class="n">isLong</span> <span class="c1">// new direction of netted position
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>FuturesOrderFill</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">FuturesOrderFill</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">orderHash</span><span class="p">,</span> <span class="c1">// EIP712 hash of order (see LibOrder.getTypedDataHash).
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// total quantity of contracts filled from this order
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">subaccountID</span><span class="p">,</span> <span class="c1">// subaccount id that created the order
</span>    <span class="kt">uint256</span> <span class="n">totalFilled</span><span class="p">,</span> <span class="c1">// total quantity of contracts filled from this order,
</span>    <span class="kt">bool</span> <span class="n">isLong</span> <span class="c1">// true if long, false if short
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>FuturesCancel</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">FuturesCancel</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">subaccountID</span><span class="p">,</span> <span class="c1">// Address that created the order.
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">orderHash</span><span class="p">,</span> <span class="c1">// EIP712 hash of order (see LibOrder.getTypedDataHash).
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// Market ID
</span>    <span class="kt">uint256</span> <span class="n">contractPrice</span><span class="p">,</span> <span class="c1">// Price of the contract
</span>    <span class="kt">uint256</span> <span class="n">quantityFilled</span><span class="p">,</span> <span class="c1">// quantity of contracts filled
</span>    <span class="kt">bool</span> <span class="n">isLong</span> <span class="c1">// true if long, false if short
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>FuturesMatch</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">FuturesMatch</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">leftOrderHash</span><span class="p">,</span> <span class="c1">// Order hash of the left order
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">rightOrderHash</span><span class="p">,</span> <span class="c1">// Order hash of the right order
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">//  Market ID
</span>    <span class="kt">uint256</span> <span class="n">quantity</span> <span class="c1">// quantity of contracts being matched.
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>FuturesLiquidation</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">FuturesLiquidation</span><span class="p">(</span>
    <span class="kt">uint256</span> <span class="k">indexed</span> <span class="n">positionID</span><span class="p">,</span> <span class="c1">// ID of the position
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">//  Market ID
</span>    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">subAccountID</span><span class="p">,</span> <span class="c1">// subaccount id
</span>    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">,</span> <span class="c1">// quantity of contracts being closed.
</span>    <span class="kt">int256</span> <span class="n">contractPNL</span> <span class="c1">// PNL for one contract
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>UpdateValuesForVWAP</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">UpdateValuesForVWAP</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">mostRecentEpochVolume</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">mostRecentEpochQuantity</span><span class="p">,</span>
    <span class="kt">int256</span> <span class="n">mostRecentEpochScaledContractIndexDiff</span>
<span class="p">);</span>
</code></pre></div>
<blockquote>
<p>MarketCreation</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">MarketCreation</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// the unique identifier of market created
</span>    <span class="kt">string</span> <span class="k">indexed</span> <span class="n">ticker</span><span class="p">,</span> <span class="c1">// the human-readable ticker for the market
</span>    <span class="kt">address</span> <span class="k">indexed</span> <span class="n">oracle</span><span class="p">,</span> <span class="c1">// the oracle address for the market
</span>    <span class="kt">address</span> <span class="n">baseCurrency</span><span class="p">,</span> <span class="c1">// the base currency address for the market
</span>    <span class="kt">uint256</span> <span class="n">maintenanceMarginRatio</span><span class="p">,</span> <span class="c1">// the maintenance margin ratio for the market
</span>    <span class="kt">uint256</span> <span class="n">initialMarginRatioFactor</span><span class="p">,</span> <span class="c1">// The minimum margin that can be used on this market's contracts purchase.
</span>    <span class="kt">uint256</span> <span class="n">makerTxFee</span><span class="p">,</span> <span class="c1">// The maker transaction fee percentage.
</span>    <span class="kt">uint256</span> <span class="n">takerTxFee</span><span class="p">,</span> <span class="c1">// The taker transaction fee percentage.
</span>    <span class="kt">uint256</span> <span class="n">relayerFeePercentage</span> <span class="c1">// The relayer transaction fee percentage.
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>AccountCreation</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">AccountCreation</span><span class="p">(</span>
    <span class="kt">address</span> <span class="k">indexed</span> <span class="n">creator</span><span class="p">,</span> <span class="c1">// account creator
</span>    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">,</span> <span class="c1">// subaccount id
</span>    <span class="kt">uint256</span> <span class="n">subAccountNonce</span> <span class="c1">// subaccount nonce
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>IncrementSubaccountDeposits</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">IncrementSubaccountDeposits</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">subAccountID</span><span class="p">,</span> <span class="c1">// subAccountID to add deposits
</span>    <span class="kt">uint256</span> <span class="n">amount</span> <span class="c1">// amount to add
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>DecrementSubaccountDeposits</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">DecrementSubaccountDeposits</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">subAccountID</span><span class="p">,</span> <span class="c1">// subAccountID to remove deposits
</span>    <span class="kt">uint256</span> <span class="n">amount</span> <span class="c1">// amount to remove
</span><span class="p">);</span>
</code></pre></div><h2 id='oracle-contract-events'>Oracle Contract Events</h2>
<blockquote>
<p>RegisterMarket</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">RegisterMarket</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// Market ID
</span>    <span class="kt">uint256</span> <span class="n">fundingInterval</span><span class="p">,</span> <span class="c1">// Funding interval
</span>    <span class="kt">uint256</span> <span class="n">initialPrice</span><span class="p">,</span> <span class="c1">// Initial price of the market
</span>    <span class="kt">uint256</span> <span class="n">timestamp</span> <span class="c1">// When the market was registered
</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p>SetPrice</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">event</span> <span class="n">SetPrice</span><span class="p">(</span>
    <span class="kt">bytes32</span> <span class="k">indexed</span> <span class="n">marketID</span><span class="p">,</span> <span class="c1">// Market ID
</span>    <span class="kt">uint256</span> <span class="n">price</span><span class="p">,</span> <span class="c1">// price
</span>    <span class="kt">uint256</span> <span class="n">timestamp</span> <span class="c1">// current timestamp
</span><span class="p">);</span>
</code></pre></div><h1 id='types'>Types</h1>
<blockquote>
<p>Order</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">Order</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">makerAddress</span><span class="p">;</span> <span class="c1">// Address that created the order.
</span>    <span class="kt">address</span> <span class="n">takerAddress</span><span class="p">;</span> <span class="c1">// Empty.
</span>    <span class="kt">address</span> <span class="n">feeRecipientAddress</span><span class="p">;</span> <span class="c1">// Address that will receive fees when order is filled.
</span>    <span class="kt">address</span> <span class="n">senderAddress</span><span class="p">;</span> <span class="c1">// Empty.
</span>    <span class="kt">uint256</span> <span class="n">makerAssetAmount</span><span class="p">;</span> <span class="c1">// The contract price i.e. the price of 1 contract denominated in base currency.
</span>    <span class="kt">uint256</span> <span class="n">takerAssetAmount</span><span class="p">;</span> <span class="c1">// The quantity of contracts the maker seeks to obtain.
</span>    <span class="kt">uint256</span> <span class="n">makerFee</span><span class="p">;</span> <span class="c1">// The amount of margin denoted in base currency the maker would like to post/risk for the order. If set to 0, the order is a Stop Loss of Take Profit order.
</span>    <span class="kt">uint256</span> <span class="n">takerFee</span><span class="p">;</span> <span class="c1">// The desired account nonce to use for cross-margining. If set the 0, the order is an isolated margin order.
</span>    <span class="kt">uint256</span> <span class="n">expirationTimeSeconds</span><span class="p">;</span> <span class="c1">// Timestamp in seconds at which order expires.
</span>    <span class="kt">uint256</span> <span class="n">salt</span><span class="p">;</span> <span class="c1">// Arbitrary number to facilitate uniqueness of the order's hash.
</span>    <span class="kt">bytes</span> <span class="n">makerAssetData</span><span class="p">;</span> <span class="c1">// The first 32 bytes contain the marketID of the market for the position if the order is LONG, empty otherwise. Right padded with 0's to be 36 bytes.
</span>    <span class="kt">bytes</span> <span class="n">takerAssetData</span><span class="p">;</span> <span class="c1">// The first 32 bytes contain the marketID of the market for the position if the order is SHORT, empty otherwise. Right padded with 0's to be 36 bytes.
</span>    <span class="kt">bytes</span> <span class="n">makerFeeAssetData</span><span class="p">;</span> <span class="c1">// The bytes-encoded positionID of the position to use for stop loss and take profit orders. Empty for vanilla make orders.
</span>    <span class="kt">bytes</span> <span class="n">takerFeeAssetData</span><span class="p">;</span> <span class="c1">// The bytes-encoded trigger price for stop limit orders. Empty for vanilla make orders.
</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>DerivativeOrderInfo</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">DerivativeOrderInfo</span> <span class="p">{</span>
    <span class="n">OrderType</span> <span class="n">orderType</span><span class="p">;</span> <span class="c1">// The order type
</span>    <span class="n">OrderStatus</span> <span class="n">orderStatus</span><span class="p">;</span> <span class="c1">// Status that describes order's validity and fillability.
</span>    <span class="kt">bytes32</span> <span class="n">orderHash</span><span class="p">;</span> <span class="c1">// EIP712 typed data hash of the order (see LibOrder.getTypedDataHash).
</span>    <span class="kt">uint256</span> <span class="n">orderTakerAssetFilledAmount</span><span class="p">;</span> <span class="c1">// Amount of order that has already been filled.
</span>    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">;</span> <span class="c1">// The subaccountID associated with the order.
</span>    <span class="n">Types</span><span class="p">.</span><span class="n">Direction</span> <span class="n">direction</span><span class="p">;</span> <span class="c1">// The direction of the order
</span>    <span class="kt">bytes32</span> <span class="n">marketID</span><span class="p">;</span> <span class="c1">// The market ID of the order
</span>    <span class="kt">uint256</span> <span class="n">entryPrice</span><span class="p">;</span> <span class="c1">// The contract price of the order
</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Account</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">Account</span> <span class="p">{</span>
    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">subAccountNonce</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Market</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">Market</span> <span class="p">{</span>
  <span class="kt">bytes32</span> <span class="n">marketID</span><span class="p">;</span>
  <span class="kt">string</span> <span class="n">ticker</span><span class="p">;</span>
  <span class="kt">address</span> <span class="n">oracle</span><span class="p">;</span>
  <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">initialMarginRatioFactor</span><span class="p">;</span>
  <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">maintenanceMarginRatio</span><span class="p">;</span>
  <span class="kt">uint256</span> <span class="n">indexPrice</span><span class="p">;</span>
  <span class="kt">uint256</span> <span class="n">nextFundingTimestamp</span><span class="p">;</span> <span class="c1">// the current funding timestamp
</span>  <span class="kt">uint256</span> <span class="n">fundingInterval</span><span class="p">;</span> <span class="c1">// defines the interval in seconds by which the nextFundingTimestamp increments
</span>  <span class="kt">int256</span> <span class="n">cumulativeFunding</span><span class="p">;</span> <span class="c1">//Stored based on one contract. /10^6
</span>  <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">makerTxFee</span><span class="p">;</span> <span class="c1">// transaction maker fee
</span>  <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">takerTxFee</span><span class="p">;</span> <span class="c1">// transaction taker fee
</span>  <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">relayerFeePercentage</span><span class="p">;</span> <span class="c1">// transaction relayer fee percentage
</span>  <span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Position</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">Position</span> <span class="p">{</span>
    <span class="c1">// subaccount owner of the position
</span>    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">;</span>
    <span class="c1">// marketID of the position
</span>    <span class="kt">bytes32</span> <span class="n">marketID</span><span class="p">;</span>
    <span class="c1">// direction of the position
</span>    <span class="n">Direction</span> <span class="n">direction</span><span class="p">;</span>
    <span class="c1">// quantity of the position
</span>    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">;</span>
    <span class="c1">// contractPrice of the position
</span>    <span class="kt">uint256</span> <span class="n">contractPrice</span><span class="p">;</span>
    <span class="c1">// the margin the trader has posted for the position
</span>    <span class="kt">uint256</span> <span class="n">margin</span><span class="p">;</span>
    <span class="c1">// The cumulative funding value. Just for perpetuals.
</span>    <span class="kt">int256</span> <span class="n">cumulativeFundingEntry</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>TransactionFees</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">TransactionFees</span> <span class="p">{</span>
    <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">maker</span><span class="p">;</span> <span class="c1">// transaction maker fee
</span>    <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">taker</span><span class="p">;</span> <span class="c1">// transaction taker fee
</span>    <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">relayer</span><span class="p">;</span> <span class="c1">// transaction relayer fee percentage
</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>TradeData</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">TradeData</span> <span class="p">{</span>
    <span class="kt">bytes32</span> <span class="n">subAccountID</span><span class="p">;</span>
    <span class="kt">bytes32</span> <span class="n">marketID</span><span class="p">;</span>
    <span class="n">Direction</span> <span class="n">direction</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">contractPrice</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">margin</span><span class="p">;</span>
    <span class="n">PermyriadMath</span><span class="p">.</span><span class="n">Permyriad</span> <span class="n">transactionFee</span><span class="p">;</span>
    <span class="kt">address</span> <span class="n">feeRecipientAddress</span><span class="p">;</span>
    <span class="kt">bytes32</span> <span class="n">orderHash</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>FillResults</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">FillResults</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">makerPositionID</span><span class="p">;</span> <span class="c1">// maker positionID
</span>    <span class="kt">uint256</span> <span class="n">takerPositionID</span><span class="p">;</span> <span class="c1">// taker positionID
</span>    <span class="kt">uint256</span> <span class="n">makerMarginUsed</span><span class="p">;</span> <span class="c1">// Total amount of margin used to create the position for the maker.
</span>    <span class="kt">uint256</span> <span class="n">takerMarginUsed</span><span class="p">;</span> <span class="c1">// Total amount of margin used to create the position for the taker.
</span>    <span class="kt">uint256</span> <span class="n">quantityFilled</span><span class="p">;</span> <span class="c1">// Total quantity of contracts filled.
</span>    <span class="kt">uint256</span> <span class="n">makerFeePaid</span><span class="p">;</span> <span class="c1">// Total amount of fee paid by maker.
</span>    <span class="kt">uint256</span> <span class="n">takerFeePaid</span><span class="p">;</span> <span class="c1">// Total amount of fee paid by taker.
</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>PositionResults</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">PositionResults</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">positionID</span><span class="p">;</span> <span class="c1">// positionID of the position that was created or modified
</span>    <span class="kt">uint256</span> <span class="n">marginUsed</span><span class="p">;</span> <span class="c1">//
</span>    <span class="kt">uint256</span> <span class="n">quantity</span><span class="p">;</span> <span class="c1">// the quantity of contracts
</span>    <span class="kt">uint256</span> <span class="n">fee</span><span class="p">;</span> <span class="c1">// the transaction fee paid
</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>MatchResults</p>
</blockquote>
<div class="highlight"><pre class="highlight solidity tab-solidity"><code><span class="k">struct</span> <span class="n">MatchResults</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">leftPositionID</span><span class="p">;</span> <span class="c1">// left order maker positionID
</span>    <span class="kt">uint256</span> <span class="n">rightPositionID</span><span class="p">;</span> <span class="c1">// left order maker positionID
</span>    <span class="kt">uint256</span> <span class="n">leftMarginUsed</span><span class="p">;</span> <span class="c1">// Total amount of margin used to create the position for the left order maker.
</span>    <span class="kt">uint256</span> <span class="n">rightMarginUsed</span><span class="p">;</span> <span class="c1">// Total amount of margin used to create the position for the right order maker.
</span>    <span class="kt">uint256</span> <span class="n">quantityFilled</span><span class="p">;</span> <span class="c1">// Total quantity of contracts filled.
</span>    <span class="kt">uint256</span> <span class="n">leftFeePaid</span><span class="p">;</span> <span class="c1">// Total amount of fee paid by left order maker.
</span>    <span class="kt">uint256</span> <span class="n">rightFeePaid</span><span class="p">;</span> <span class="c1">// Total amount of fee paid by left order maker.
</span><span class="p">}</span>
</code></pre></div>
      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">Shell</a>
                <a href="#" data-language-name="typescript">TypeScript</a>
          </div>
      </div>
    </div>
  </body>
</html>
